---
title: "Modeling Co-Usage"
author: 
date: "7/31/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(cdlTools)
library(noncensus)
library(tibble)
library(ggplot2)
library(caret)
library(randomForest)
library(scales)
library(ipred)
library(rpart)
library(tidyr)
library(sparklyr)
library(caret)
library(ipred)
library(magrittr)
library(data.table)
library(InformationValue)

```

##### Loading Datasets into be recoded

```{r}

# Loading the datasets

TEDS01 <- read.csv("/group/bprice5/noblis_data_18/TEDS-A-1992-2012-DS0001-bndl-data-tsv/TEDS-A-1992-2012-DS0001-data/TEDS-A-1992-2012-DS0001-data-excel.tsv", sep = "\t")

TEDS02 <- read.csv("/group/bprice5/noblis_data_18/TEDS-A-1992-2012-DS0002-bndl-data-tsv/TEDS-A-1992-2012-DS0002-data/TEDS-A-1992-2012-DS0002-data-excel.tsv", sep = "\t")

TEDS03 <- read.csv("/group/bprice5/noblis_data_18/TEDS-A-1992-2012-DS0003-bndl-data-tsv/TEDS-A-1992-2012-DS0003-data/TEDS-A-1992-2012-DS0003-data-excel.tsv", sep = "\t")

TEDS04 <- read.csv("/group/bprice5/noblis_data_18/TEDS-A-1992-2012-DS0004-bndl-data-tsv/TEDS-A-1992-2012-DS0004-data/TEDS-A-1992-2012-DS0004-data-excel.tsv", sep = "\t")

TEDS05 <- read.csv("/group/bprice5/noblis_data_18/TEDS-A-1992-2012-DS0005-bndl-data-tsv/TEDS-A-1992-2012-DS0005-data/TEDS-A-1992-2012-DS0005-data-excel.tsv", sep = "\t")

TEDS06 <- read.csv("/group/bprice5/noblis_data_18/TEDS-A-2013-DS0001-bndl-data-tsv/TEDS-A-2013-DS0001-data/TEDS-A-2013-DS0001-data-excel.csv", sep = ",")

TEDS07 <- read.csv("/group/bprice5/noblis_data_18/TEDS-A-2014-DS0001-bndl-data-tsv/TEDS-A-2014-DS0001-data/TEDS-A-2014-DS0001-data-excel.csv", sep = ",")
TEDS07 <- add_column(TEDS07, PMSA = "Not Collected for this year", .after = 17)

TEDS08 <- read.csv("/group/bprice5/noblis_data_18/TEDSA_2015_PUF.csv", sep = ",")
TEDS08 <- add_column(TEDS08, PMSA = "Not Collected for this year", .after = 17)
colnames(TEDS08)[17] <- "CBSA"

```

```{r}

# Verifying that the variable names match across all datasets

names01 <- names(TEDS01)
names02 <- names(TEDS02)
names03 <- names(TEDS03)
names04 <- names(TEDS04)
names05 <- names(TEDS05)
names06 <- names(TEDS06)
names07 <- names(TEDS07)
names08 <- names(TEDS08)

names01 == names02
names02 == names03
names03 == names04
names04 == names05
names05 == names06
names01 == names07
names01 == names08

(nameserror <- names01 %in% names08)

names01[nameserror == FALSE]

```

##### Recoding to Meaningful Values and Column Names

```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS01$AGE <- with(TEDS01, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS01$GENDER <- with(TEDS01, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS01$RACE <- with(TEDS01, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS01)[6] <- "ETHNICITY"
TEDS01$ETHNICITY <- with(TEDS01, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS01)[7] <- "MARITAL_STATUS"
TEDS01$MARITAL_STATUS <- with(TEDS01, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS01$EDUC <- with(TEDS01, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS01)[9] <- "EMPLOYMENT_STATUS"
TEDS01$EMPLOYMENT_STATUS <- with(TEDS01, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS01)[10] <- "DET_NIL_CATEGORY"
TEDS01$DET_NIL_CATEGORY <- with(TEDS01, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS01)[11] <- "PREGNANT"
TEDS01$PREGNANT <- with(TEDS01, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS01)[12] <- "VETERAN"
TEDS01$VETERAN <- with(TEDS01, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS01)[13] <- "LIVING_ARR"
TEDS01$LIVING_ARR <- with(TEDS01, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS01)[14] <- "PRIMARY_INC"
TEDS01$PRIMARY_INC <- with(TEDS01, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS01$ARRESTS <- with(TEDS01, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS01)[16] <- "STATE"
TEDS01$STATE <- fips(TEDS01$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
data("corebased_areas")
recodingCBSA <- TEDS01 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS01$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS01)[18] <- "METRO_MSA"
#TEDS01$METRO_MSA <- TEDS01

# Region  19
TEDS01$REGION <- with(TEDS01, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS01)[20] <- "CENSUS_DIV"
TEDS01$CENSUS_DIV <- with(TEDS01, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS01$SERVSETA <- with(TEDS01, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS01)[22] <- "METH_BUP_TREAT"
TEDS01$METH_BUP_TREAT <- with(TEDS01, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS01$DAYWAIT <- with(TEDS01, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS01$PSOURCE <- with(TEDS01, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS01$DETCRIM <- with(TEDS01, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS01)[26] <- "NUM_PRIOR"
TEDS01$NUM_PRIOR <- with(TEDS01, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS01)[27] <- "PRIME_SUB"
TEDS01$PRIME_SUB <- with(TEDS01, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS01)[28] <- "ROUTE_PRIME"
TEDS01$ROUTE_PRIME <- with(TEDS01, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS01)[29] <- "FREQ_PRIME"
TEDS01$FREQ_PRIME <- with(TEDS01, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS01)[30] <- "FRSTUSE_PRIME"
TEDS01$FRSTUSE_PRIME <- with(TEDS01, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS01)[31] <- "SEC_SUB"
TEDS01$SEC_SUB <- with(TEDS01, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS01)[32] <- "ROUTE_SEC"
TEDS01$ROUTE_SEC <- with(TEDS01, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS01)[33] <- "FREQ_SEC"
TEDS01$FREQ_SEC <- with(TEDS01, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS01)[34] <- "FRSTUSE_SEC"
TEDS01$FRSTUSE_SEC <- with(TEDS01, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS01)[35] <- "TERT_SUB"
TEDS01$TERT_SUB <- with(TEDS01, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS01)[36] <- "ROUTE_TERT"
TEDS01$ROUTE_TERT <- with(TEDS01, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS01)[37] <- "FREQ_TERT"
TEDS01$FREQ_TERT <- with(TEDS01, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS01)[38] <- "FRSTUSE_TERT"
TEDS01$FRSTUSE_TERT <- with(TEDS01, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS01$NUMSUBS <- with(TEDS01, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS01)[40] <- "IV_DRUG_AT_ADM"
TEDS01$IV_DRUG_AT_ADM <- with(TEDS01, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS01)[41] <- "ALCOHOL_AT_ADM"
TEDS01$ALCOHOL_AT_ADM <- with(TEDS01, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS01)[42] <- "COKE_AT_ADM"
TEDS01$COKE_AT_ADM <- with(TEDS01, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS01)[43] <- "MAR_AT_ADM"
TEDS01$MAR_AT_ADM <- with(TEDS01, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS01)[44] <- "HER_AT_ADM"
TEDS01$HER_AT_ADM <- with(TEDS01, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS01)[45] <- "METH_AT_ADM"
TEDS01$METH_AT_ADM <- with(TEDS01, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS01)[46] <- "OPIATE_AT_ADM"
TEDS01$OPIATE_AT_ADM <- with(TEDS01, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS01)[47] <- "PCP_AT_ADM"
TEDS01$PCP_AT_ADM <- with(TEDS01, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS01)[48] <- "HALL_AT_ADM"
TEDS01$HALL_AT_ADM <- with(TEDS01, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS01)[49] <- "MTHAMP_AT_ADM"
TEDS01$MTHAMP_AT_ADM <- with(TEDS01, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS01)[50] <- "AMPHET_AT_ADM"
TEDS01$AMPHET_AT_ADM <- with(TEDS01, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS01)[51] <- "STIM_AT_ADM"
TEDS01$STIM_AT_ADM <- with(TEDS01, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS01)[52] <- "BENZO_AT_ADM"
TEDS01$BENZO_AT_ADM <- with(TEDS01, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS01)[53] <- "TRANQ_AT_ADM"
TEDS01$TRANQ_AT_ADM <- with(TEDS01, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS01)[54] <- "BARB_AT_ADM"
TEDS01$BARB_AT_ADM <- with(TEDS01, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS01)[55] <- "SED_HYP_AT_ADM"
TEDS01$SED_HYP_AT_ADM <- with(TEDS01, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS01)[56] <- "INHAL_AT_ADM"
TEDS01$INHAL_AT_ADM <- with(TEDS01, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS01)[57] <- "OTC_AT_ADM"
TEDS01$OTC_AT_ADM <- with(TEDS01, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS01)[58] <- "OTHER_AT_ADM"
TEDS01$OTHER_AT_ADM <- with(TEDS01, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS01)[59] <- "SUB_ABUSE_TYPE"
TEDS01$SUB_ABUSE_TYPE <- with(TEDS01, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS01)[60] <- "DSM_DIAG"
TEDS01$DSM_DIAG <- with(TEDS01, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS01$PSYPROB <- with(TEDS01, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS01$HLTHINS <- with(TEDS01, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS01$PRIMPAY <- with(TEDS01, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))

```


```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS02$AGE <- with(TEDS02, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS02$GENDER <- with(TEDS02, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS02$RACE <- with(TEDS02, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS02)[6] <- "ETHNICITY"
TEDS02$ETHNICITY <- with(TEDS02, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS02)[7] <- "MARITAL_STATUS"
TEDS02$MARITAL_STATUS <- with(TEDS02, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS02$EDUC <- with(TEDS02, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS02)[9] <- "EMPLOYMENT_STATUS"
TEDS02$EMPLOYMENT_STATUS <- with(TEDS02, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS02)[10] <- "DET_NIL_CATEGORY"
TEDS02$DET_NIL_CATEGORY <- with(TEDS02, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS02)[11] <- "PREGNANT"
TEDS02$PREGNANT <- with(TEDS02, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS02)[12] <- "VETERAN"
TEDS02$VETERAN <- with(TEDS02, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS02)[13] <- "LIVING_ARR"
TEDS02$LIVING_ARR <- with(TEDS02, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS02)[14] <- "PRIMARY_INC"
TEDS02$PRIMARY_INC <- with(TEDS02, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS02$ARRESTS <- with(TEDS02, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS02)[16] <- "STATE"
TEDS02$STATE <- fips(TEDS02$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
recodingCBSA <- TEDS02 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS02$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS02)[18] <- "METRO_MSA"
#TEDS02$METRO_MSA <- TEDS02

# Region  19
TEDS02$REGION <- with(TEDS02, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS02)[20] <- "CENSUS_DIV"
TEDS02$CENSUS_DIV <- with(TEDS02, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS02$SERVSETA <- with(TEDS02, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS02)[22] <- "METH_BUP_TREAT"
TEDS02$METH_BUP_TREAT <- with(TEDS02, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS02$DAYWAIT <- with(TEDS02, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS02$PSOURCE <- with(TEDS02, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS02$DETCRIM <- with(TEDS02, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS02)[26] <- "NUM_PRIOR"
TEDS02$NUM_PRIOR <- with(TEDS02, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS02)[27] <- "PRIME_SUB"
TEDS02$PRIME_SUB <- with(TEDS02, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS02)[28] <- "ROUTE_PRIME"
TEDS02$ROUTE_PRIME <- with(TEDS02, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS02)[29] <- "FREQ_PRIME"
TEDS02$FREQ_PRIME <- with(TEDS02, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS02)[30] <- "FRSTUSE_PRIME"
TEDS02$FRSTUSE_PRIME <- with(TEDS02, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS02)[31] <- "SEC_SUB"
TEDS02$SEC_SUB <- with(TEDS02, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS02)[32] <- "ROUTE_SEC"
TEDS02$ROUTE_SEC <- with(TEDS02, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS02)[33] <- "FREQ_SEC"
TEDS02$FREQ_SEC <- with(TEDS02, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS02)[34] <- "FRSTUSE_SEC"
TEDS02$FRSTUSE_SEC <- with(TEDS02, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS02)[35] <- "TERT_SUB"
TEDS02$TERT_SUB <- with(TEDS02, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS02)[36] <- "ROUTE_TERT"
TEDS02$ROUTE_TERT <- with(TEDS02, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS02)[37] <- "FREQ_TERT"
TEDS02$FREQ_TERT <- with(TEDS02, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS02)[38] <- "FRSTUSE_TERT"
TEDS02$FRSTUSE_TERT <- with(TEDS02, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS02$NUMSUBS <- with(TEDS02, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS02)[40] <- "IV_DRUG_AT_ADM"
TEDS02$IV_DRUG_AT_ADM <- with(TEDS02, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS02)[41] <- "ALCOHOL_AT_ADM"
TEDS02$ALCOHOL_AT_ADM <- with(TEDS02, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS02)[42] <- "COKE_AT_ADM"
TEDS02$COKE_AT_ADM <- with(TEDS02, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS02)[43] <- "MAR_AT_ADM"
TEDS02$MAR_AT_ADM <- with(TEDS02, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS02)[44] <- "HER_AT_ADM"
TEDS02$HER_AT_ADM <- with(TEDS02, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS02)[45] <- "METH_AT_ADM"
TEDS02$METH_AT_ADM <- with(TEDS02, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS02)[46] <- "OPIATE_AT_ADM"
TEDS02$OPIATE_AT_ADM <- with(TEDS02, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS02)[47] <- "PCP_AT_ADM"
TEDS02$PCP_AT_ADM <- with(TEDS02, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS02)[48] <- "HALL_AT_ADM"
TEDS02$HALL_AT_ADM <- with(TEDS02, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS02)[49] <- "MTHAMP_AT_ADM"
TEDS02$MTHAMP_AT_ADM <- with(TEDS02, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS02)[50] <- "AMPHET_AT_ADM"
TEDS02$AMPHET_AT_ADM <- with(TEDS02, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS02)[51] <- "STIM_AT_ADM"
TEDS02$STIM_AT_ADM <- with(TEDS02, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS02)[52] <- "BENZO_AT_ADM"
TEDS02$BENZO_AT_ADM <- with(TEDS02, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS02)[53] <- "TRANQ_AT_ADM"
TEDS02$TRANQ_AT_ADM <- with(TEDS02, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS02)[54] <- "BARB_AT_ADM"
TEDS02$BARB_AT_ADM <- with(TEDS02, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS02)[55] <- "SED_HYP_AT_ADM"
TEDS02$SED_HYP_AT_ADM <- with(TEDS02, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS02)[56] <- "INHAL_AT_ADM"
TEDS02$INHAL_AT_ADM <- with(TEDS02, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS02)[57] <- "OTC_AT_ADM"
TEDS02$OTC_AT_ADM <- with(TEDS02, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS02)[58] <- "OTHER_AT_ADM"
TEDS02$OTHER_AT_ADM <- with(TEDS02, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS02)[59] <- "SUB_ABUSE_TYPE"
TEDS02$SUB_ABUSE_TYPE <- with(TEDS02, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS02)[60] <- "DSM_DIAG"
TEDS02$DSM_DIAG <- with(TEDS02, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS02$PSYPROB <- with(TEDS02, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS02$HLTHINS <- with(TEDS02, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS02$PRIMPAY <- with(TEDS02, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))

```


```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS03$AGE <- with(TEDS03, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS03$GENDER <- with(TEDS03, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS03$RACE <- with(TEDS03, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS03)[6] <- "ETHNICITY"
TEDS03$ETHNICITY <- with(TEDS03, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS03)[7] <- "MARITAL_STATUS"
TEDS03$MARITAL_STATUS <- with(TEDS03, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS03$EDUC <- with(TEDS03, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS03)[9] <- "EMPLOYMENT_STATUS"
TEDS03$EMPLOYMENT_STATUS <- with(TEDS03, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS03)[10] <- "DET_NIL_CATEGORY"
TEDS03$DET_NIL_CATEGORY <- with(TEDS03, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS03)[11] <- "PREGNANT"
TEDS03$PREGNANT <- with(TEDS03, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS03)[12] <- "VETERAN"
TEDS03$VETERAN <- with(TEDS03, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS03)[13] <- "LIVING_ARR"
TEDS03$LIVING_ARR <- with(TEDS03, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS03)[14] <- "PRIMARY_INC"
TEDS03$PRIMARY_INC <- with(TEDS03, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS03$ARRESTS <- with(TEDS03, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS03)[16] <- "STATE"
TEDS03$STATE <- fips(TEDS03$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
recodingCBSA <- TEDS03 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS03$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS03)[18] <- "METRO_MSA"
#TEDS03$METRO_MSA <- TEDS03

# Region  19
TEDS03$REGION <- with(TEDS03, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS03)[20] <- "CENSUS_DIV"
TEDS03$CENSUS_DIV <- with(TEDS03, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS03$SERVSETA <- with(TEDS03, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS03)[22] <- "METH_BUP_TREAT"
TEDS03$METH_BUP_TREAT <- with(TEDS03, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS03$DAYWAIT <- with(TEDS03, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS03$PSOURCE <- with(TEDS03, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS03$DETCRIM <- with(TEDS03, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS03)[26] <- "NUM_PRIOR"
TEDS03$NUM_PRIOR <- with(TEDS03, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS03)[27] <- "PRIME_SUB"
TEDS03$PRIME_SUB <- with(TEDS03, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS03)[28] <- "ROUTE_PRIME"
TEDS03$ROUTE_PRIME <- with(TEDS03, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS03)[29] <- "FREQ_PRIME"
TEDS03$FREQ_PRIME <- with(TEDS03, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS03)[30] <- "FRSTUSE_PRIME"
TEDS03$FRSTUSE_PRIME <- with(TEDS03, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS03)[31] <- "SEC_SUB"
TEDS03$SEC_SUB <- with(TEDS03, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS03)[32] <- "ROUTE_SEC"
TEDS03$ROUTE_SEC <- with(TEDS03, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS03)[33] <- "FREQ_SEC"
TEDS03$FREQ_SEC <- with(TEDS03, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS03)[34] <- "FRSTUSE_SEC"
TEDS03$FRSTUSE_SEC <- with(TEDS03, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS03)[35] <- "TERT_SUB"
TEDS03$TERT_SUB <- with(TEDS03, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS03)[36] <- "ROUTE_TERT"
TEDS03$ROUTE_TERT <- with(TEDS03, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS03)[37] <- "FREQ_TERT"
TEDS03$FREQ_TERT <- with(TEDS03, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS03)[38] <- "FRSTUSE_TERT"
TEDS03$FRSTUSE_TERT <- with(TEDS03, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS03$NUMSUBS <- with(TEDS03, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS03)[40] <- "IV_DRUG_AT_ADM"
TEDS03$IV_DRUG_AT_ADM <- with(TEDS03, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS03)[41] <- "ALCOHOL_AT_ADM"
TEDS03$ALCOHOL_AT_ADM <- with(TEDS03, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS03)[42] <- "COKE_AT_ADM"
TEDS03$COKE_AT_ADM <- with(TEDS03, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS03)[43] <- "MAR_AT_ADM"
TEDS03$MAR_AT_ADM <- with(TEDS03, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS03)[44] <- "HER_AT_ADM"
TEDS03$HER_AT_ADM <- with(TEDS03, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS03)[45] <- "METH_AT_ADM"
TEDS03$METH_AT_ADM <- with(TEDS03, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS03)[46] <- "OPIATE_AT_ADM"
TEDS03$OPIATE_AT_ADM <- with(TEDS03, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS03)[47] <- "PCP_AT_ADM"
TEDS03$PCP_AT_ADM <- with(TEDS03, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS03)[48] <- "HALL_AT_ADM"
TEDS03$HALL_AT_ADM <- with(TEDS03, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS03)[49] <- "MTHAMP_AT_ADM"
TEDS03$MTHAMP_AT_ADM <- with(TEDS03, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS03)[50] <- "AMPHET_AT_ADM"
TEDS03$AMPHET_AT_ADM <- with(TEDS03, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS03)[51] <- "STIM_AT_ADM"
TEDS03$STIM_AT_ADM <- with(TEDS03, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS03)[52] <- "BENZO_AT_ADM"
TEDS03$BENZO_AT_ADM <- with(TEDS03, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS03)[53] <- "TRANQ_AT_ADM"
TEDS03$TRANQ_AT_ADM <- with(TEDS03, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS03)[54] <- "BARB_AT_ADM"
TEDS03$BARB_AT_ADM <- with(TEDS03, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS03)[55] <- "SED_HYP_AT_ADM"
TEDS03$SED_HYP_AT_ADM <- with(TEDS03, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS03)[56] <- "INHAL_AT_ADM"
TEDS03$INHAL_AT_ADM <- with(TEDS03, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS03)[57] <- "OTC_AT_ADM"
TEDS03$OTC_AT_ADM <- with(TEDS03, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS03)[58] <- "OTHER_AT_ADM"
TEDS03$OTHER_AT_ADM <- with(TEDS03, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS03)[59] <- "SUB_ABUSE_TYPE"
TEDS03$SUB_ABUSE_TYPE <- with(TEDS03, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS03)[60] <- "DSM_DIAG"
TEDS03$DSM_DIAG <- with(TEDS03, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS03$PSYPROB <- with(TEDS03, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS03$HLTHINS <- with(TEDS03, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS03$PRIMPAY <- with(TEDS03, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))


```


```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS04$AGE <- with(TEDS04, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS04$GENDER <- with(TEDS04, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS04$RACE <- with(TEDS04, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS04)[6] <- "ETHNICITY"
TEDS04$ETHNICITY <- with(TEDS04, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS04)[7] <- "MARITAL_STATUS"
TEDS04$MARITAL_STATUS <- with(TEDS04, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS04$EDUC <- with(TEDS04, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS04)[9] <- "EMPLOYMENT_STATUS"
TEDS04$EMPLOYMENT_STATUS <- with(TEDS04, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS04)[10] <- "DET_NIL_CATEGORY"
TEDS04$DET_NIL_CATEGORY <- with(TEDS04, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS04)[11] <- "PREGNANT"
TEDS04$PREGNANT <- with(TEDS04, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS04)[12] <- "VETERAN"
TEDS04$VETERAN <- with(TEDS04, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS04)[13] <- "LIVING_ARR"
TEDS04$LIVING_ARR <- with(TEDS04, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS04)[14] <- "PRIMARY_INC"
TEDS04$PRIMARY_INC <- with(TEDS04, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS04$ARRESTS <- with(TEDS04, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS04)[16] <- "STATE"
TEDS04$STATE <- fips(TEDS04$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
recodingCBSA <- TEDS04 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS04$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS04)[18] <- "METRO_MSA"
#TEDS04$METRO_MSA <- TEDS04

# Region  19
TEDS04$REGION <- with(TEDS04, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS04)[20] <- "CENSUS_DIV"
TEDS04$CENSUS_DIV <- with(TEDS04, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS04$SERVSETA <- with(TEDS04, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS04)[22] <- "METH_BUP_TREAT"
TEDS04$METH_BUP_TREAT <- with(TEDS04, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS04$DAYWAIT <- with(TEDS04, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS04$PSOURCE <- with(TEDS04, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS04$DETCRIM <- with(TEDS04, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS04)[26] <- "NUM_PRIOR"
TEDS04$NUM_PRIOR <- with(TEDS04, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS04)[27] <- "PRIME_SUB"
TEDS04$PRIME_SUB <- with(TEDS04, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS04)[28] <- "ROUTE_PRIME"
TEDS04$ROUTE_PRIME <- with(TEDS04, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS04)[29] <- "FREQ_PRIME"
TEDS04$FREQ_PRIME <- with(TEDS04, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS04)[30] <- "FRSTUSE_PRIME"
TEDS04$FRSTUSE_PRIME <- with(TEDS04, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS04)[31] <- "SEC_SUB"
TEDS04$SEC_SUB <- with(TEDS04, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS04)[32] <- "ROUTE_SEC"
TEDS04$ROUTE_SEC <- with(TEDS04, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS04)[33] <- "FREQ_SEC"
TEDS04$FREQ_SEC <- with(TEDS04, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS04)[34] <- "FRSTUSE_SEC"
TEDS04$FRSTUSE_SEC <- with(TEDS04, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS04)[35] <- "TERT_SUB"
TEDS04$TERT_SUB <- with(TEDS04, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS04)[36] <- "ROUTE_TERT"
TEDS04$ROUTE_TERT <- with(TEDS04, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS04)[37] <- "FREQ_TERT"
TEDS04$FREQ_TERT <- with(TEDS04, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS04)[38] <- "FRSTUSE_TERT"
TEDS04$FRSTUSE_TERT <- with(TEDS04, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS04$NUMSUBS <- with(TEDS04, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS04)[40] <- "IV_DRUG_AT_ADM"
TEDS04$IV_DRUG_AT_ADM <- with(TEDS04, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS04)[41] <- "ALCOHOL_AT_ADM"
TEDS04$ALCOHOL_AT_ADM <- with(TEDS04, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS04)[42] <- "COKE_AT_ADM"
TEDS04$COKE_AT_ADM <- with(TEDS04, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS04)[43] <- "MAR_AT_ADM"
TEDS04$MAR_AT_ADM <- with(TEDS04, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS04)[44] <- "HER_AT_ADM"
TEDS04$HER_AT_ADM <- with(TEDS04, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS04)[45] <- "METH_AT_ADM"
TEDS04$METH_AT_ADM <- with(TEDS04, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS04)[46] <- "OPIATE_AT_ADM"
TEDS04$OPIATE_AT_ADM <- with(TEDS04, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS04)[47] <- "PCP_AT_ADM"
TEDS04$PCP_AT_ADM <- with(TEDS04, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS04)[48] <- "HALL_AT_ADM"
TEDS04$HALL_AT_ADM <- with(TEDS04, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS04)[49] <- "MTHAMP_AT_ADM"
TEDS04$MTHAMP_AT_ADM <- with(TEDS04, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS04)[50] <- "AMPHET_AT_ADM"
TEDS04$AMPHET_AT_ADM <- with(TEDS04, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS04)[51] <- "STIM_AT_ADM"
TEDS04$STIM_AT_ADM <- with(TEDS04, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS04)[52] <- "BENZO_AT_ADM"
TEDS04$BENZO_AT_ADM <- with(TEDS04, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS04)[53] <- "TRANQ_AT_ADM"
TEDS04$TRANQ_AT_ADM <- with(TEDS04, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS04)[54] <- "BARB_AT_ADM"
TEDS04$BARB_AT_ADM <- with(TEDS04, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS04)[55] <- "SED_HYP_AT_ADM"
TEDS04$SED_HYP_AT_ADM <- with(TEDS04, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS04)[56] <- "INHAL_AT_ADM"
TEDS04$INHAL_AT_ADM <- with(TEDS04, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS04)[57] <- "OTC_AT_ADM"
TEDS04$OTC_AT_ADM <- with(TEDS04, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS04)[58] <- "OTHER_AT_ADM"
TEDS04$OTHER_AT_ADM <- with(TEDS04, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS04)[59] <- "SUB_ABUSE_TYPE"
TEDS04$SUB_ABUSE_TYPE <- with(TEDS04, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS04)[60] <- "DSM_DIAG"
TEDS04$DSM_DIAG <- with(TEDS04, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS04$PSYPROB <- with(TEDS04, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS04$HLTHINS <- with(TEDS04, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS04$PRIMPAY <- with(TEDS04, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))


```


```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS05$AGE <- with(TEDS05, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS05$GENDER <- with(TEDS05, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS05$RACE <- with(TEDS05, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS05)[6] <- "ETHNICITY"
TEDS05$ETHNICITY <- with(TEDS05, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS05)[7] <- "MARITAL_STATUS"
TEDS05$MARITAL_STATUS <- with(TEDS05, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS05$EDUC <- with(TEDS05, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS05)[9] <- "EMPLOYMENT_STATUS"
TEDS05$EMPLOYMENT_STATUS <- with(TEDS05, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS05)[10] <- "DET_NIL_CATEGORY"
TEDS05$DET_NIL_CATEGORY <- with(TEDS05, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS05)[11] <- "PREGNANT"
TEDS05$PREGNANT <- with(TEDS05, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS05)[12] <- "VETERAN"
TEDS05$VETERAN <- with(TEDS05, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS05)[13] <- "LIVING_ARR"
TEDS05$LIVING_ARR <- with(TEDS05, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS05)[14] <- "PRIMARY_INC"
TEDS05$PRIMARY_INC <- with(TEDS05, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS05$ARRESTS <- with(TEDS05, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS05)[16] <- "STATE"
TEDS05$STATE <- fips(TEDS05$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
recodingCBSA <- TEDS05 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS05$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS05)[18] <- "METRO_MSA"
#TEDS05$METRO_MSA <- TEDS05

# Region  19
TEDS05$REGION <- with(TEDS05, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS05)[20] <- "CENSUS_DIV"
TEDS05$CENSUS_DIV <- with(TEDS05, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS05$SERVSETA <- with(TEDS05, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS05)[22] <- "METH_BUP_TREAT"
TEDS05$METH_BUP_TREAT <- with(TEDS05, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS05$DAYWAIT <- with(TEDS05, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS05$PSOURCE <- with(TEDS05, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS05$DETCRIM <- with(TEDS05, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS05)[26] <- "NUM_PRIOR"
TEDS05$NUM_PRIOR <- with(TEDS05, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS05)[27] <- "PRIME_SUB"
TEDS05$PRIME_SUB <- with(TEDS05, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS05)[28] <- "ROUTE_PRIME"
TEDS05$ROUTE_PRIME <- with(TEDS05, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS05)[29] <- "FREQ_PRIME"
TEDS05$FREQ_PRIME <- with(TEDS05, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS05)[30] <- "FRSTUSE_PRIME"
TEDS05$FRSTUSE_PRIME <- with(TEDS05, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS05)[31] <- "SEC_SUB"
TEDS05$SEC_SUB <- with(TEDS05, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS05)[32] <- "ROUTE_SEC"
TEDS05$ROUTE_SEC <- with(TEDS05, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS05)[33] <- "FREQ_SEC"
TEDS05$FREQ_SEC <- with(TEDS05, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS05)[34] <- "FRSTUSE_SEC"
TEDS05$FRSTUSE_SEC <- with(TEDS05, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS05)[35] <- "TERT_SUB"
TEDS05$TERT_SUB <- with(TEDS05, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS05)[36] <- "ROUTE_TERT"
TEDS05$ROUTE_TERT <- with(TEDS05, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS05)[37] <- "FREQ_TERT"
TEDS05$FREQ_TERT <- with(TEDS05, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS05)[38] <- "FRSTUSE_TERT"
TEDS05$FRSTUSE_TERT <- with(TEDS05, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS05$NUMSUBS <- with(TEDS05, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS05)[40] <- "IV_DRUG_AT_ADM"
TEDS05$IV_DRUG_AT_ADM <- with(TEDS05, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS05)[41] <- "ALCOHOL_AT_ADM"
TEDS05$ALCOHOL_AT_ADM <- with(TEDS05, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS05)[42] <- "COKE_AT_ADM"
TEDS05$COKE_AT_ADM <- with(TEDS05, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS05)[43] <- "MAR_AT_ADM"
TEDS05$MAR_AT_ADM <- with(TEDS05, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS05)[44] <- "HER_AT_ADM"
TEDS05$HER_AT_ADM <- with(TEDS05, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS05)[45] <- "METH_AT_ADM"
TEDS05$METH_AT_ADM <- with(TEDS05, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS05)[46] <- "OPIATE_AT_ADM"
TEDS05$OPIATE_AT_ADM <- with(TEDS05, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS05)[47] <- "PCP_AT_ADM"
TEDS05$PCP_AT_ADM <- with(TEDS05, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS05)[48] <- "HALL_AT_ADM"
TEDS05$HALL_AT_ADM <- with(TEDS05, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS05)[49] <- "MTHAMP_AT_ADM"
TEDS05$MTHAMP_AT_ADM <- with(TEDS05, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS05)[50] <- "AMPHET_AT_ADM"
TEDS05$AMPHET_AT_ADM <- with(TEDS05, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS05)[51] <- "STIM_AT_ADM"
TEDS05$STIM_AT_ADM <- with(TEDS05, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS05)[52] <- "BENZO_AT_ADM"
TEDS05$BENZO_AT_ADM <- with(TEDS05, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS05)[53] <- "TRANQ_AT_ADM"
TEDS05$TRANQ_AT_ADM <- with(TEDS05, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS05)[54] <- "BARB_AT_ADM"
TEDS05$BARB_AT_ADM <- with(TEDS05, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS05)[55] <- "SED_HYP_AT_ADM"
TEDS05$SED_HYP_AT_ADM <- with(TEDS05, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS05)[56] <- "INHAL_AT_ADM"
TEDS05$INHAL_AT_ADM <- with(TEDS05, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS05)[57] <- "OTC_AT_ADM"
TEDS05$OTC_AT_ADM <- with(TEDS05, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS05)[58] <- "OTHER_AT_ADM"
TEDS05$OTHER_AT_ADM <- with(TEDS05, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS05)[59] <- "SUB_ABUSE_TYPE"
TEDS05$SUB_ABUSE_TYPE <- with(TEDS05, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS05)[60] <- "DSM_DIAG"
TEDS05$DSM_DIAG <- with(TEDS05, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS05$PSYPROB <- with(TEDS05, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS05$HLTHINS <- with(TEDS05, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS05$PRIMPAY <- with(TEDS05, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))



```


```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS06$AGE <- with(TEDS06, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS06$GENDER <- with(TEDS06, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS06$RACE <- with(TEDS06, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS06)[6] <- "ETHNICITY"
TEDS06$ETHNICITY <- with(TEDS06, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS06)[7] <- "MARITAL_STATUS"
TEDS06$MARITAL_STATUS <- with(TEDS06, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS06$EDUC <- with(TEDS06, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS06)[9] <- "EMPLOYMENT_STATUS"
TEDS06$EMPLOYMENT_STATUS <- with(TEDS06, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS06)[10] <- "DET_NIL_CATEGORY"
TEDS06$DET_NIL_CATEGORY <- with(TEDS06, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS06)[11] <- "PREGNANT"
TEDS06$PREGNANT <- with(TEDS06, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS06)[12] <- "VETERAN"
TEDS06$VETERAN <- with(TEDS06, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS06)[13] <- "LIVING_ARR"
TEDS06$LIVING_ARR <- with(TEDS06, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS06)[14] <- "PRIMARY_INC"
TEDS06$PRIMARY_INC <- with(TEDS06, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS06$ARRESTS <- with(TEDS06, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS06)[16] <- "STATE"
TEDS06$STATE <- fips(TEDS06$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
recodingCBSA <- TEDS06 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS06$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS06)[18] <- "METRO_MSA"
#TEDS06$METRO_MSA <- TEDS06

# Region  19
TEDS06$REGION <- with(TEDS06, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS06)[20] <- "CENSUS_DIV"
TEDS06$CENSUS_DIV <- with(TEDS06, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS06$SERVSETA <- with(TEDS06, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS06)[22] <- "METH_BUP_TREAT"
TEDS06$METH_BUP_TREAT <- with(TEDS06, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS06$DAYWAIT <- with(TEDS06, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS06$PSOURCE <- with(TEDS06, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS06$DETCRIM <- with(TEDS06, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS06)[26] <- "NUM_PRIOR"
TEDS06$NUM_PRIOR <- with(TEDS06, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS06)[27] <- "PRIME_SUB"
TEDS06$PRIME_SUB <- with(TEDS06, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS06)[28] <- "ROUTE_PRIME"
TEDS06$ROUTE_PRIME <- with(TEDS06, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS06)[29] <- "FREQ_PRIME"
TEDS06$FREQ_PRIME <- with(TEDS06, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS06)[30] <- "FRSTUSE_PRIME"
TEDS06$FRSTUSE_PRIME <- with(TEDS06, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS06)[31] <- "SEC_SUB"
TEDS06$SEC_SUB <- with(TEDS06, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS06)[32] <- "ROUTE_SEC"
TEDS06$ROUTE_SEC <- with(TEDS06, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS06)[33] <- "FREQ_SEC"
TEDS06$FREQ_SEC <- with(TEDS06, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS06)[34] <- "FRSTUSE_SEC"
TEDS06$FRSTUSE_SEC <- with(TEDS06, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS06)[35] <- "TERT_SUB"
TEDS06$TERT_SUB <- with(TEDS06, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS06)[36] <- "ROUTE_TERT"
TEDS06$ROUTE_TERT <- with(TEDS06, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS06)[37] <- "FREQ_TERT"
TEDS06$FREQ_TERT <- with(TEDS06, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS06)[38] <- "FRSTUSE_TERT"
TEDS06$FRSTUSE_TERT <- with(TEDS06, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS06$NUMSUBS <- with(TEDS06, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS06)[40] <- "IV_DRUG_AT_ADM"
TEDS06$IV_DRUG_AT_ADM <- with(TEDS06, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS06)[41] <- "ALCOHOL_AT_ADM"
TEDS06$ALCOHOL_AT_ADM <- with(TEDS06, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS06)[42] <- "COKE_AT_ADM"
TEDS06$COKE_AT_ADM <- with(TEDS06, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS06)[43] <- "MAR_AT_ADM"
TEDS06$MAR_AT_ADM <- with(TEDS06, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS06)[44] <- "HER_AT_ADM"
TEDS06$HER_AT_ADM <- with(TEDS06, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS06)[45] <- "METH_AT_ADM"
TEDS06$METH_AT_ADM <- with(TEDS06, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS06)[46] <- "OPIATE_AT_ADM"
TEDS06$OPIATE_AT_ADM <- with(TEDS06, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS06)[47] <- "PCP_AT_ADM"
TEDS06$PCP_AT_ADM <- with(TEDS06, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS06)[48] <- "HALL_AT_ADM"
TEDS06$HALL_AT_ADM <- with(TEDS06, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS06)[49] <- "MTHAMP_AT_ADM"
TEDS06$MTHAMP_AT_ADM <- with(TEDS06, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS06)[50] <- "AMPHET_AT_ADM"
TEDS06$AMPHET_AT_ADM <- with(TEDS06, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS06)[51] <- "STIM_AT_ADM"
TEDS06$STIM_AT_ADM <- with(TEDS06, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS06)[52] <- "BENZO_AT_ADM"
TEDS06$BENZO_AT_ADM <- with(TEDS06, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS06)[53] <- "TRANQ_AT_ADM"
TEDS06$TRANQ_AT_ADM <- with(TEDS06, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS06)[54] <- "BARB_AT_ADM"
TEDS06$BARB_AT_ADM <- with(TEDS06, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS06)[55] <- "SED_HYP_AT_ADM"
TEDS06$SED_HYP_AT_ADM <- with(TEDS06, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS06)[56] <- "INHAL_AT_ADM"
TEDS06$INHAL_AT_ADM <- with(TEDS06, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS06)[57] <- "OTC_AT_ADM"
TEDS06$OTC_AT_ADM <- with(TEDS06, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS06)[58] <- "OTHER_AT_ADM"
TEDS06$OTHER_AT_ADM <- with(TEDS06, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS06)[59] <- "SUB_ABUSE_TYPE"
TEDS06$SUB_ABUSE_TYPE <- with(TEDS06, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS06)[60] <- "DSM_DIAG"
TEDS06$DSM_DIAG <- with(TEDS06, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS06$PSYPROB <- with(TEDS06, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS06$HLTHINS <- with(TEDS06, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS06$PRIMPAY <- with(TEDS06, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))



```

```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS07$AGE <- with(TEDS07, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS07$GENDER <- with(TEDS07, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS07$RACE <- with(TEDS07, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS07)[6] <- "ETHNICITY"
TEDS07$ETHNICITY <- with(TEDS07, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS07)[7] <- "MARITAL_STATUS"
TEDS07$MARITAL_STATUS <- with(TEDS07, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS07$EDUC <- with(TEDS07, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS07)[9] <- "EMPLOYMENT_STATUS"
TEDS07$EMPLOYMENT_STATUS <- with(TEDS07, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS07)[10] <- "DET_NIL_CATEGORY"
TEDS07$DET_NIL_CATEGORY <- with(TEDS07, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS07)[11] <- "PREGNANT"
TEDS07$PREGNANT <- with(TEDS07, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS07)[12] <- "VETERAN"
TEDS07$VETERAN <- with(TEDS07, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS07)[13] <- "LIVING_ARR"
TEDS07$LIVING_ARR <- with(TEDS07, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS07)[14] <- "PRIMARY_INC"
TEDS07$PRIMARY_INC <- with(TEDS07, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS07$ARRESTS <- with(TEDS07, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS07)[16] <- "STATE"
TEDS07$STATE <- fips(TEDS07$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
recodingCBSA <- TEDS07 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS07$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS07)[18] <- "METRO_MSA"
#TEDS07$METRO_MSA <- TEDS07

# Region  19
TEDS07$REGION <- with(TEDS07, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS07)[20] <- "CENSUS_DIV"
TEDS07$CENSUS_DIV <- with(TEDS07, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS07$SERVSETA <- with(TEDS07, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS07)[22] <- "METH_BUP_TREAT"
TEDS07$METH_BUP_TREAT <- with(TEDS07, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS07$DAYWAIT <- with(TEDS07, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS07$PSOURCE <- with(TEDS07, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS07$DETCRIM <- with(TEDS07, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS07)[26] <- "NUM_PRIOR"
TEDS07$NUM_PRIOR <- with(TEDS07, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS07)[27] <- "PRIME_SUB"
TEDS07$PRIME_SUB <- with(TEDS07, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS07)[28] <- "ROUTE_PRIME"
TEDS07$ROUTE_PRIME <- with(TEDS07, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS07)[29] <- "FREQ_PRIME"
TEDS07$FREQ_PRIME <- with(TEDS07, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS07)[30] <- "FRSTUSE_PRIME"
TEDS07$FRSTUSE_PRIME <- with(TEDS07, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS07)[31] <- "SEC_SUB"
TEDS07$SEC_SUB <- with(TEDS07, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS07)[32] <- "ROUTE_SEC"
TEDS07$ROUTE_SEC <- with(TEDS07, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS07)[33] <- "FREQ_SEC"
TEDS07$FREQ_SEC <- with(TEDS07, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS07)[34] <- "FRSTUSE_SEC"
TEDS07$FRSTUSE_SEC <- with(TEDS07, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS07)[35] <- "TERT_SUB"
TEDS07$TERT_SUB <- with(TEDS07, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS07)[36] <- "ROUTE_TERT"
TEDS07$ROUTE_TERT <- with(TEDS07, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS07)[37] <- "FREQ_TERT"
TEDS07$FREQ_TERT <- with(TEDS07, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS07)[38] <- "FRSTUSE_TERT"
TEDS07$FRSTUSE_TERT <- with(TEDS07, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS07$NUMSUBS <- with(TEDS07, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS07)[40] <- "IV_DRUG_AT_ADM"
TEDS07$IV_DRUG_AT_ADM <- with(TEDS07, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS07)[41] <- "ALCOHOL_AT_ADM"
TEDS07$ALCOHOL_AT_ADM <- with(TEDS07, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS07)[42] <- "COKE_AT_ADM"
TEDS07$COKE_AT_ADM <- with(TEDS07, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS07)[43] <- "MAR_AT_ADM"
TEDS07$MAR_AT_ADM <- with(TEDS07, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS07)[44] <- "HER_AT_ADM"
TEDS07$HER_AT_ADM <- with(TEDS07, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS07)[45] <- "METH_AT_ADM"
TEDS07$METH_AT_ADM <- with(TEDS07, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS07)[46] <- "OPIATE_AT_ADM"
TEDS07$OPIATE_AT_ADM <- with(TEDS07, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS07)[47] <- "PCP_AT_ADM"
TEDS07$PCP_AT_ADM <- with(TEDS07, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS07)[48] <- "HALL_AT_ADM"
TEDS07$HALL_AT_ADM <- with(TEDS07, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS07)[49] <- "MTHAMP_AT_ADM"
TEDS07$MTHAMP_AT_ADM <- with(TEDS07, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS07)[50] <- "AMPHET_AT_ADM"
TEDS07$AMPHET_AT_ADM <- with(TEDS07, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS07)[51] <- "STIM_AT_ADM"
TEDS07$STIM_AT_ADM <- with(TEDS07, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS07)[52] <- "BENZO_AT_ADM"
TEDS07$BENZO_AT_ADM <- with(TEDS07, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS07)[53] <- "TRANQ_AT_ADM"
TEDS07$TRANQ_AT_ADM <- with(TEDS07, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS07)[54] <- "BARB_AT_ADM"
TEDS07$BARB_AT_ADM <- with(TEDS07, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS07)[55] <- "SED_HYP_AT_ADM"
TEDS07$SED_HYP_AT_ADM <- with(TEDS07, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS07)[56] <- "INHAL_AT_ADM"
TEDS07$INHAL_AT_ADM <- with(TEDS07, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS07)[57] <- "OTC_AT_ADM"
TEDS07$OTC_AT_ADM <- with(TEDS07, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS07)[58] <- "OTHER_AT_ADM"
TEDS07$OTHER_AT_ADM <- with(TEDS07, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS07)[59] <- "SUB_ABUSE_TYPE"
TEDS07$SUB_ABUSE_TYPE <- with(TEDS07, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS07)[60] <- "DSM_DIAG"
TEDS07$DSM_DIAG <- with(TEDS07, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS07$PSYPROB <- with(TEDS07, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS07$HLTHINS <- with(TEDS07, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS07$PRIMPAY <- with(TEDS07, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))

```


```{r}

# Recoding Fields to have value meanings rather than just codes.

# Age
TEDS08$AGE <- with(TEDS08, ifelse(AGE == 2, "12-14",
                                            ifelse(AGE == 3, "15-17",
                                            ifelse(AGE == 4, "18-20",
                                            ifelse(AGE == 5, "21-24",
                                            ifelse(AGE == 6, "25-29",
                                            ifelse(AGE == 7, "30-34",
                                            ifelse(AGE == 8, "35-39",
                                            ifelse(AGE == 9, "40-44",
                                            ifelse(AGE == 10, "45-49",
                                            ifelse(AGE == 11, "50-54",
                                            ifelse(AGE == 12, "55 & Over",
                                                   AGE))))))))))))

# Gender
TEDS08$GENDER <- with(TEDS08, ifelse(GENDER == 1, "Male",
                                              ifelse(GENDER == 2, "Female",
                                              ifelse(GENDER == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                     GENDER))))

# Race
TEDS08$RACE <- with(TEDS08, ifelse(RACE == 1, "Alaska Native (Aleut, Eskimo, Indian)",
                                            ifelse(RACE == 2, "American Indian (Other Than Alaska Native)",
                                            ifelse(RACE == 3, "Asian or Pacific Islander",
                                            ifelse(RACE == 4, "Black or African American",
                                            ifelse(RACE == 5, "White",
                                            ifelse(RACE == 13, "Asian",
                                            ifelse(RACE == 20, "Other Single Races",
                                            ifelse(RACE == 21, "Two of More Races",
                                            ifelse(RACE == 23, "Native Hawaiian or Other Pacific Islander",
                                            ifelse(RACE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   RACE)))))))))))


# Ethnicity (Hispanic Origin)
colnames(TEDS08)[6] <- "ETHNICITY"
TEDS08$ETHNICITY <- with(TEDS08, ifelse(ETHNICITY == 1, "Puerto Rican",
                                                  ifelse(ETHNICITY == 2, "Mexican",
                                                  ifelse(ETHNICITY == 3, "Cuban",
                                                  ifelse(ETHNICITY == 4, "Other Specific Hispanic",
                                                  ifelse(ETHNICITY == 5, "Not of Hispanic Origin",
                                                  ifelse(ETHNICITY == 6, "Hispanic, Specific Origin No Specified", 
                                                  ifelse(ETHNICITY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ETHNICITY))))))))

# Marital Status
colnames(TEDS08)[7] <- "MARITAL_STATUS"
TEDS08$MARITAL_STATUS <- with(TEDS08, ifelse(MARITAL_STATUS == 1, "Never Married",
                                                      ifelse(MARITAL_STATUS == 2, "Now Married",
                                                      ifelse(MARITAL_STATUS == 3, "Separated",
                                                      ifelse(MARITAL_STATUS == 4, "Divorced, Widowed",
                                                      ifelse(MARITAL_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             MARITAL_STATUS))))))


# Number of Years of Education
TEDS08$EDUC <- with(TEDS08, ifelse(EDUC == 1, "8 Years or Less",
                                            ifelse(EDUC == 2, "9-11",
                                            ifelse(EDUC == 3, "12",
                                            ifelse(EDUC == 4, "13-15",
                                            ifelse(EDUC == 5, "16 or More",
                                            ifelse(EDUC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                   EDUC)))))))

# Employment Status
colnames(TEDS08)[9] <- "EMPLOYMENT_STATUS"
TEDS08$EMPLOYMENT_STATUS <- with(TEDS08, ifelse(EMPLOYMENT_STATUS == 1, "Full Time",
                                                          ifelse(EMPLOYMENT_STATUS == 2, "Part Time",
                                                          ifelse(EMPLOYMENT_STATUS == 3, "Unemployed",
                                                          ifelse(EMPLOYMENT_STATUS == 4, "Not in Labor Force",
                                                          ifelse(EMPLOYMENT_STATUS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                 EMPLOYMENT_STATUS))))))


# Detailed Not in Labor Force Category
colnames(TEDS08)[10] <- "DET_NIL_CATEGORY"
TEDS08$DET_NIL_CATEGORY <- with(TEDS08, ifelse(DET_NIL_CATEGORY == 1, "Homemaker",
                                                                ifelse(DET_NIL_CATEGORY == 2, "Student",
                                                                ifelse(DET_NIL_CATEGORY == 3, "Retired, Disabled",
                                                                ifelse(DET_NIL_CATEGORY == 5, "Inmate of Institution",
                                                                ifelse(DET_NIL_CATEGORY == 6, "Other",
                                                                ifelse(DET_NIL_CATEGORY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                                       DET_NIL_CATEGORY)))))))


# Pregane at time of admission
colnames(TEDS08)[11] <- "PREGNANT"
TEDS08$PREGNANT <- with(TEDS08, ifelse(PREGNANT == 1, "Yes",
                                                  ifelse(PREGNANT == 2, "No",
                                                  ifelse(PREGNANT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PREGNANT))))


# Veteran Status
colnames(TEDS08)[12] <- "VETERAN"
TEDS08$VETERAN <- with(TEDS08, ifelse(VETERAN == 1, "Yes",
                                                  ifelse(VETERAN == 2, "No",
                                                  ifelse(VETERAN == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         VETERAN))))

# Living Arrangements
colnames(TEDS08)[13] <- "LIVING_ARR"
TEDS08$LIVING_ARR <- with(TEDS08, ifelse(LIVING_ARR == 1, "Homeless",
                                                    ifelse(LIVING_ARR == 2, "Dependent Living",
                                                    ifelse(LIVING_ARR == 3, "Independent Living",
                                                    ifelse(LIVING_ARR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           LIVING_ARR)))))

# Primary Income Source
colnames(TEDS08)[14] <- "PRIMARY_INC"
TEDS08$PRIMARY_INC <- with(TEDS08, ifelse(PRIMARY_INC == 1, "Wages/Salary",
                                                      ifelse(PRIMARY_INC == 2, "Public Assistance",
                                                      ifelse(PRIMARY_INC == 3, "Retirement/Pension, Disability",
                                                      ifelse(PRIMARY_INC == 20, "Other",
                                                      ifelse(PRIMARY_INC == 21, "None",
                                                      ifelse(PRIMARY_INC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             PRIMARY_INC)))))))


# Number of Arrests in 30 days prior to admission
TEDS08$ARRESTS <- with(TEDS08, ifelse(ARRESTS == 0, "None",
                                                  ifelse(ARRESTS == 1, "Once",
                                                  ifelse(ARRESTS == 2, "2 or More Times",
                                                  ifelse(ARRESTS == -8, "Not Collected for this Year",
                                                  ifelse(ARRESTS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         ARRESTS))))))

# State
colnames(TEDS08)[16] <- "STATE"
TEDS08$STATE <- fips(TEDS08$STATE, to = "Name")


# CBSA Core Based Statistical Area 17
recodingCBSA <- TEDS08 %>% 
  left_join(select(corebased_areas, CBSA, name), by = "CBSA")
TEDS08$CBSA <- recodingCBSA$name


# PMSA 1990 Metroplitan Statistical Area 18
#colnames(TEDS08)[18] <- "METRO_MSA"
#TEDS08$METRO_MSA <- TEDS08

# Region  19
TEDS08$REGION <- with(TEDS08, ifelse(REGION == 0, "US Jurisdiction.Territory",
                                                  ifelse(REGION == 1, "Northeast",
                                                  ifelse(REGION == 2, "Midwest",
                                                  ifelse(REGION == 3, "South",
                                                  ifelse(REGION == 4, "West",
                                                  ifelse(REGION == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         REGION)))))))


# Census Division 20
colnames(TEDS08)[20] <- "CENSUS_DIV"
TEDS08$CENSUS_DIV <- with(TEDS08, ifelse(CENSUS_DIV == 0, "US Jurisdiction.Territory",
                                                    ifelse(CENSUS_DIV == 1, "New England",
                                                    ifelse(CENSUS_DIV == 2, "Mid-Atlantic",
                                                    ifelse(CENSUS_DIV == 3, "East North Central",
                                                    ifelse(CENSUS_DIV == 4, "West North Central",
                                                    ifelse(CENSUS_DIV == 5, "South Atlantic",
                                                    ifelse(CENSUS_DIV == 6, "East South Central",
                                                    ifelse(CENSUS_DIV == 7, "West South Central",
                                                    ifelse(CENSUS_DIV == 8, "Mountain",
                                                    ifelse(CENSUS_DIV == 9, "Pacific",
                                                    ifelse(CENSUS_DIV == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           CENSUS_DIV))))))))))))


# Service Setting at Admission 21
TEDS08$SERVSETA <- with(TEDS08, ifelse(SERVSETA == 1, "Detox, 24 HR, Hospital Inpatient",
                                                  ifelse(SERVSETA == 2, "Detox, 24 HR, Free Standing Residentyial",
                                                  ifelse(SERVSETA == 3, "Rehab, Hospital (Non-Detox)",
                                                  ifelse(SERVSETA == 4, "Rehab, Short Term (30 Days or Fewers)",
                                                  ifelse(SERVSETA == 5, "Rehab, Long Term (More Than 30 Days",
                                                  ifelse(SERVSETA == 6, "Ambulatory, Intensive Outpatient",
                                                  ifelse(SERVSETA == 7, "Ambulatory, Non-Intensive Outpatient",
                                                  ifelse(SERVSETA == 8, "Ambulatory, Detoxification",
                                                  ifelse(SERVSETA == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         SERVSETA))))))))))


# METHUSE: Medication-Assited Opioid Therapy - Use of Methadone or Buprenorphine is part of the treatment plan.
colnames(TEDS08)[22] <- "METH_BUP_TREAT"
TEDS08$METH_BUP_TREAT <- with(TEDS08, ifelse(METH_BUP_TREAT == 1, "Yes",
                                                        ifelse(METH_BUP_TREAT == 2, "No",
                                                        ifelse(METH_BUP_TREAT== -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               METH_BUP_TREAT))))

# Days Waiting to Enter Treatment 23 -- 
TEDS08$DAYWAIT <- with(TEDS08, ifelse(DAYWAIT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        DAYWAIT))


# PSOURCE Principal Source of Referral 24
TEDS08$PSOURCE <- with(TEDS08, ifelse(PSOURCE == 1, "Individual (Includes Self-Referral)",
                                                  ifelse(PSOURCE == 2, "Alcohol/Drug Abusde Care Provider",
                                                  ifelse(PSOURCE == 3, "Other Health Care Provider",
                                                  ifelse(PSOURCE == 4, "School (Educational)",
                                                  ifelse(PSOURCE == 5, "Employer/EAP",
                                                  ifelse(PSOURCE == 6, "Other Community Referral",
                                                  ifelse(PSOURCE == 7, "Court/Criminal Justice Referral DUI/DWI",
                                                  ifelse(PSOURCE == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSOURCE)))))))))



# DETCRIM Detailed Criminal Justice Referral 25
TEDS08$DETCRIM <- with(TEDS08, ifelse(DETCRIM == 1, "State/Federal Court, Other Court",
                                                  ifelse(DETCRIM == 2, "Probation/Parole",
                                                  ifelse(DETCRIM == 3, "Diversionary Program",       
                                                  ifelse(DETCRIM == 4, "Prison",
                                                  ifelse(DETCRIM == 5, "DUI/DWI",
                                                  ifelse(DETCRIM == 6, "Other Recognized Legal Entity, Other",
                                                  ifelse(DETCRIM == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DETCRIM))))))))


# NOPRIOR Number of prior treatment episodes
colnames(TEDS08)[26] <- "NUM_PRIOR"
TEDS08$NUM_PRIOR <- with(TEDS08, ifelse(NUM_PRIOR == 0, "None",
                                                    ifelse(NUM_PRIOR == 1, "1",
                                                    ifelse(NUM_PRIOR == 2, "2",
                                                    ifelse(NUM_PRIOR == 3, "3",
                                                    ifelse(NUM_PRIOR == 4, "4",
                                                    ifelse(NUM_PRIOR == 5, "5 or more",
                                                    ifelse(NUM_PRIOR == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           NUM_PRIOR))))))))


# SUB1 Substance Problem Code (Primary)
colnames(TEDS08)[27] <- "PRIME_SUB"
TEDS08$PRIME_SUB <- with(TEDS08, ifelse(PRIME_SUB == 1, "None",
                                                  ifelse(PRIME_SUB == 2, "Alcohol",       
                                                  ifelse(PRIME_SUB == 3, "Cocaine/Crack",
                                                  ifelse(PRIME_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(PRIME_SUB == 5, "Heroin",
                                                  ifelse(PRIME_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(PRIME_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(PRIME_SUB == 8, "PCP",
                                                  ifelse(PRIME_SUB == 9, "Other Hallucinogens",
                                                  ifelse(PRIME_SUB == 10, "Methamphetamine",
                                                  ifelse(PRIME_SUB == 11, "Other Amphetamines",
                                                  ifelse(PRIME_SUB == 12, "Other Stimulants",
                                                  ifelse(PRIME_SUB == 13, "Benzodiazpines",
                                                  ifelse(PRIME_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(PRIME_SUB == 15, "Barbituates",
                                                  ifelse(PRIME_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(PRIME_SUB == 17, "Inhalants",
                                                  ifelse(PRIME_SUB == 18, "OTC Medications",
                                                  ifelse(PRIME_SUB == 20, "Other",
                                                  ifelse(PRIME_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  PRIME_SUB)))))))))))))))))))))

# ROUTE1 Usual Route of administration of primary substance
colnames(TEDS08)[28] <- "ROUTE_PRIME"
TEDS08$ROUTE_PRIME <- with(TEDS08, ifelse(ROUTE_PRIME == 1, "Oral",
                                                      ifelse(ROUTE_PRIME == 2, "Smoking",
                                                      ifelse(ROUTE_PRIME == 3, "Inhalation",
                                                      ifelse(ROUTE_PRIME == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_PRIME == 20, "Other",
                                                      ifelse(ROUTE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_PRIME)))))))

# FREQ1 Frequency of Use Primary substance
colnames(TEDS08)[29] <- "FREQ_PRIME"
TEDS08$FREQ_PRIME <- with(TEDS08, ifelse(FREQ_PRIME == 1, "No Use in Past Month",
                                                    ifelse(FREQ_PRIME == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_PRIME == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_PRIME == 5, "Daily",
                                                    ifelse(FREQ_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_PRIME)))))))


# FRSTUSE1 Age at first use of primary substance
colnames(TEDS08)[30] <- "FRSTUSE_PRIME"
TEDS08$FRSTUSE_PRIME <- with(TEDS08, ifelse(FRSTUSE_PRIME == 1, "11 and Under",
                                                        ifelse(FRSTUSE_PRIME == 2, "12-14", 
                                                        ifelse(FRSTUSE_PRIME == 3, "15-17",
                                                        ifelse(FRSTUSE_PRIME == 4, "18-20",  
                                                        ifelse(FRSTUSE_PRIME == 5, "21-24", 
                                                        ifelse(FRSTUSE_PRIME == 6, "25-29", 
                                                        ifelse(FRSTUSE_PRIME == 7, "30-34", 
                                                        ifelse(FRSTUSE_PRIME == 8, "35-39", 
                                                        ifelse(FRSTUSE_PRIME == 9, "40-44", 
                                                        ifelse(FRSTUSE_PRIME == 10, "45-49", 
                                                        ifelse(FRSTUSE_PRIME == 11, "50-54", 
                                                        ifelse(FRSTUSE_PRIME == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_PRIME == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_PRIME))))))))))))))


# SUB2 Substance Problem Secondary
colnames(TEDS08)[31] <- "SEC_SUB"
TEDS08$SEC_SUB <- with(TEDS08, ifelse(SEC_SUB == 1, "None",
                                                  ifelse(SEC_SUB == 2, "Alcohol",       
                                                  ifelse(SEC_SUB == 3, "Cocaine/Crack",
                                                  ifelse(SEC_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(SEC_SUB == 5, "Heroin",
                                                  ifelse(SEC_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(SEC_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(SEC_SUB == 8, "PCP",
                                                  ifelse(SEC_SUB == 9, "Other Hallucinogens",
                                                  ifelse(SEC_SUB == 10, "Methamphetamine",
                                                  ifelse(SEC_SUB == 11, "Other Amphetamines",
                                                  ifelse(SEC_SUB == 12, "Other Stimulants",
                                                  ifelse(SEC_SUB == 13, "Benzodiazpines",
                                                  ifelse(SEC_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(SEC_SUB == 15, "Barbituates",
                                                  ifelse(SEC_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(SEC_SUB == 17, "Inhalants",
                                                  ifelse(SEC_SUB == 18, "OTC Medications",
                                                  ifelse(SEC_SUB == 20, "Other",
                                                  ifelse(SEC_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  SEC_SUB)))))))))))))))))))))

# ROUTE2 Usual Route of administration of primary substance
colnames(TEDS08)[32] <- "ROUTE_SEC"
TEDS08$ROUTE_SEC <- with(TEDS08, ifelse(ROUTE_SEC == 1, "Oral",
                                                      ifelse(ROUTE_SEC == 2, "Smoking",
                                                      ifelse(ROUTE_SEC == 3, "Inhalation",
                                                      ifelse(ROUTE_SEC == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_SEC == 20, "Other",
                                                      ifelse(ROUTE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_SEC)))))))

# FREQ2 Frequency of Use Primary substance
colnames(TEDS08)[33] <- "FREQ_SEC"
TEDS08$FREQ_SEC <- with(TEDS08, ifelse(FREQ_SEC == 1, "No Use in Past Month",
                                                    ifelse(FREQ_SEC == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_SEC == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_SEC == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_SEC == 5, "Daily",
                                                    ifelse(FREQ_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_SEC)))))))


# FRSTUSE2 Age at first use of primary substance
colnames(TEDS08)[34] <- "FRSTUSE_SEC"
TEDS08$FRSTUSE_SEC <- with(TEDS08, ifelse(FRSTUSE_SEC == 1, "11 and Under",
                                                        ifelse(FRSTUSE_SEC == 2, "12-14", 
                                                        ifelse(FRSTUSE_SEC == 3, "15-17",
                                                        ifelse(FRSTUSE_SEC == 4, "18-20",  
                                                        ifelse(FRSTUSE_SEC == 5, "21-24", 
                                                        ifelse(FRSTUSE_SEC == 6, "25-29", 
                                                        ifelse(FRSTUSE_SEC == 7, "30-34", 
                                                        ifelse(FRSTUSE_SEC == 8, "35-39", 
                                                        ifelse(FRSTUSE_SEC == 9, "40-44", 
                                                        ifelse(FRSTUSE_SEC == 10, "45-49", 
                                                        ifelse(FRSTUSE_SEC == 11, "50-54", 
                                                        ifelse(FRSTUSE_SEC == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_SEC == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_SEC))))))))))))))



# SUB3 Substance problem at check in tertiary
colnames(TEDS08)[35] <- "TERT_SUB"
TEDS08$TERT_SUB <- with(TEDS08, ifelse(TERT_SUB == 1, "None",
                                                  ifelse(TERT_SUB == 2, "Alcohol",       
                                                  ifelse(TERT_SUB == 3, "Cocaine/Crack",
                                                  ifelse(TERT_SUB == 4, "Marijuana/Hashish",
                                                  ifelse(TERT_SUB == 5, "Heroin",
                                                  ifelse(TERT_SUB == 6, "Non-Prescription Methadone",
                                                  ifelse(TERT_SUB == 7, "Other Opiates & Synthetics",
                                                  ifelse(TERT_SUB == 8, "PCP",
                                                  ifelse(TERT_SUB == 9, "Other Hallucinogens",
                                                  ifelse(TERT_SUB == 10, "Methamphetamine",
                                                  ifelse(TERT_SUB == 11, "Other Amphetamines",
                                                  ifelse(TERT_SUB == 12, "Other Stimulants",
                                                  ifelse(TERT_SUB == 13, "Benzodiazpines",
                                                  ifelse(TERT_SUB == 14, "Other Non-Benzodiazepine Tranquilizers",
                                                  ifelse(TERT_SUB == 15, "Barbituates",
                                                  ifelse(TERT_SUB == 16, "Other Non-Barbituate Sedatives or Hypnotics",
                                                  ifelse(TERT_SUB == 17, "Inhalants",
                                                  ifelse(TERT_SUB == 18, "OTC Medications",
                                                  ifelse(TERT_SUB == 20, "Other",
                                                  ifelse(TERT_SUB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                  TERT_SUB)))))))))))))))))))))

# ROUTE3 Usual Route of administration of primary substance
colnames(TEDS08)[36] <- "ROUTE_TERT"
TEDS08$ROUTE_TERT <- with(TEDS08, ifelse(ROUTE_TERT == 1, "Oral",
                                                      ifelse(ROUTE_TERT == 2, "Smoking",
                                                      ifelse(ROUTE_TERT == 3, "Inhalation",
                                                      ifelse(ROUTE_TERT == 4, "Injection IV or Intramuscular",
                                                      ifelse(ROUTE_TERT == 20, "Other",
                                                      ifelse(ROUTE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                             ROUTE_TERT)))))))

# FREQ3 Frequency of Use Primary substance
colnames(TEDS08)[37] <- "FREQ_TERT"
TEDS08$FREQ_TERT <- with(TEDS08, ifelse(FREQ_TERT == 1, "No Use in Past Month",
                                                    ifelse(FREQ_TERT == 2, "1-3 Times in Past Month",
                                                    ifelse(FREQ_TERT == 3, "1-2 Times in Past Week",
                                                    ifelse(FREQ_TERT == 4, "3-6 Times in Past Week",
                                                    ifelse(FREQ_TERT == 5, "Daily",
                                                    ifelse(FREQ_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                           FREQ_TERT)))))))


# FRSTUSE3 Age at first use of primary substance
colnames(TEDS08)[38] <- "FRSTUSE_TERT"
TEDS08$FRSTUSE_TERT <- with(TEDS08, ifelse(FRSTUSE_TERT == 1, "11 and Under",
                                                        ifelse(FRSTUSE_TERT == 2, "12-14", 
                                                        ifelse(FRSTUSE_TERT == 3, "15-17",
                                                        ifelse(FRSTUSE_TERT == 4, "18-20",  
                                                        ifelse(FRSTUSE_TERT == 5, "21-24", 
                                                        ifelse(FRSTUSE_TERT == 6, "25-29", 
                                                        ifelse(FRSTUSE_TERT == 7, "30-34", 
                                                        ifelse(FRSTUSE_TERT == 8, "35-39", 
                                                        ifelse(FRSTUSE_TERT == 9, "40-44", 
                                                        ifelse(FRSTUSE_TERT == 10, "45-49", 
                                                        ifelse(FRSTUSE_TERT == 11, "50-54", 
                                                        ifelse(FRSTUSE_TERT == 12, "55 and Over", 
                                                        ifelse(FRSTUSE_TERT == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                               FRSTUSE_TERT))))))))))))))

# NUMSUBS Number of Substance at Checkin 39 
TEDS08$NUMSUBS <- with(TEDS08, ifelse(NUMSUBS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                        NUMSUBS))


# IDU Current IV Drug use reported at Admission
colnames(TEDS08)[40] <- "IV_DRUG_AT_ADM"
TEDS08$IV_DRUG_AT_ADM <- with(TEDS08, ifelse(IV_DRUG_AT_ADM == 0, "No",
                                                  ifelse(IV_DRUG_AT_ADM == 1, "Yes",
                                                  ifelse(IV_DRUG_AT_ADM == -8, "No Substances Reported",
                                                         IV_DRUG_AT_ADM))))


# ALCFLG ALcohol Report at Admission
colnames(TEDS08)[41] <- "ALCOHOL_AT_ADM"
TEDS08$ALCOHOL_AT_ADM <- with(TEDS08, ifelse(ALCOHOL_AT_ADM == 0, "No",
                                                        ifelse(ALCOHOL_AT_ADM == 1, "Yes",
                                                               ALCOHOL_AT_ADM)))


# COKEFLG Cocaine/Crack Reported at Admission
colnames(TEDS08)[42] <- "COKE_AT_ADM"
TEDS08$COKE_AT_ADM <- with(TEDS08, ifelse(COKE_AT_ADM == 0, "No",
                                                      ifelse(COKE_AT_ADM == 1, "Yes",
                                                             COKE_AT_ADM)))

# MARFLG Marijuana/Hashish Reported at Admission
colnames(TEDS08)[43] <- "MAR_AT_ADM"
TEDS08$MAR_AT_ADM <- with(TEDS08, ifelse(MAR_AT_ADM == 0, "No",
                                                      ifelse(MAR_AT_ADM == 1, "Yes",
                                                             MAR_AT_ADM)))
# HERFLG Heroin Reported at Admission
colnames(TEDS08)[44] <- "HER_AT_ADM"
TEDS08$HER_AT_ADM <- with(TEDS08, ifelse(HER_AT_ADM == 0, "No",
                                                      ifelse(HER_AT_ADM == 1, "Yes",
                                                             HER_AT_ADM)))

# METHFLG Non-RX Methadon Reported at Admission
colnames(TEDS08)[45] <- "METH_AT_ADM"
TEDS08$METH_AT_ADM <- with(TEDS08, ifelse(METH_AT_ADM == 0, "No",
                                                      ifelse(METH_AT_ADM == 1, "Yes",
                                                             METH_AT_ADM)))

# OPSYNFLG Other Opiates/Synthetics Reported at Admission
colnames(TEDS08)[46] <- "OPIATE_AT_ADM"
TEDS08$OPIATE_AT_ADM <- with(TEDS08, ifelse(OPIATE_AT_ADM == 0, "No",
                                                      ifelse(OPIATE_AT_ADM == 1, "Yes",
                                                             OPIATE_AT_ADM)))

# PCPFLG PCP Reported at Admission
colnames(TEDS08)[47] <- "PCP_AT_ADM"
TEDS08$PCP_AT_ADM <- with(TEDS08, ifelse(PCP_AT_ADM == 0, "No",
                                                      ifelse(PCP_AT_ADM == 1, "Yes",
                                                             PCP_AT_ADM)))


# HALLFLG Hallucinogens Reported at Admission
colnames(TEDS08)[48] <- "HALL_AT_ADM"
TEDS08$HALL_AT_ADM <- with(TEDS08, ifelse(HALL_AT_ADM == 0, "No",
                                                      ifelse(HALL_AT_ADM == 1, "Yes",
                                                             HALL_AT_ADM)))


# MTHAMPFLG Methamphetamine Reported at Admission
colnames(TEDS08)[49] <- "MTHAMP_AT_ADM"
TEDS08$MTHAMP_AT_ADM <- with(TEDS08, ifelse(MTHAMP_AT_ADM == 0, "No",
                                                      ifelse(MTHAMP_AT_ADM == 1, "Yes",
                                                             MTHAMP_AT_ADM)))


# AMPHFLG Other Amphetamines Reported at Admission
colnames(TEDS08)[50] <- "AMPHET_AT_ADM"
TEDS08$AMPHET_AT_ADM <- with(TEDS08, ifelse(AMPHET_AT_ADM == 0, "No",
                                                      ifelse(AMPHET_AT_ADM == 1, "Yes",
                                                             AMPHET_AT_ADM)))


# STIMFLG Otheer Stimulants Reported at Admission
colnames(TEDS08)[51] <- "STIM_AT_ADM"
TEDS08$STIM_AT_ADM <- with(TEDS08, ifelse(STIM_AT_ADM == 0, "No",
                                                      ifelse(STIM_AT_ADM == 1, "Yes",
                                                             STIM_AT_ADM)))



# BENZFLG Benzodiazepines Reported at Admission
colnames(TEDS08)[52] <- "BENZO_AT_ADM"
TEDS08$BENZO_AT_ADM <- with(TEDS08, ifelse(BENZO_AT_ADM == 0, "No",
                                                      ifelse(BENZO_AT_ADM == 1, "Yes",
                                                             BENZO_AT_ADM)))

# TRNQFLG Other Non-Benzo Tranquilizers Reported at Admission
colnames(TEDS08)[53] <- "TRANQ_AT_ADM"
TEDS08$TRANQ_AT_ADM <- with(TEDS08, ifelse(TRANQ_AT_ADM == 0, "No",
                                                      ifelse(TRANQ_AT_ADM == 1, "Yes",
                                                             TRANQ_AT_ADM)))


# BARBFLG Barbituates Reported at Admission
colnames(TEDS08)[54] <- "BARB_AT_ADM"
TEDS08$BARB_AT_ADM <- with(TEDS08, ifelse(BARB_AT_ADM == 0, "No",
                                                      ifelse(BARB_AT_ADM == 1, "Yes",
                                                             BARB_AT_ADM)))


# SEDHPFLG Other Non-Barbituate Sedatives/Hypnotics Reported at Admission
colnames(TEDS08)[55] <- "SED_HYP_AT_ADM"
TEDS08$SED_HYP_AT_ADM <- with(TEDS08, ifelse(SED_HYP_AT_ADM == 0, "No",
                                                      ifelse(SED_HYP_AT_ADM == 1, "Yes",
                                                             SED_HYP_AT_ADM)))


# INHFLG Inhalants Reported at Admission
colnames(TEDS08)[56] <- "INHAL_AT_ADM"
TEDS08$INHAL_AT_ADM <- with(TEDS08, ifelse(INHAL_AT_ADM == 0, "No",
                                                      ifelse(INHAL_AT_ADM == 1, "Yes",
                                                             INHAL_AT_ADM)))


# OTCFLG Over-the-Counter Medications Reported at Admission
colnames(TEDS08)[57] <- "OTC_AT_ADM"
TEDS08$OTC_AT_ADM <- with(TEDS08, ifelse(OTC_AT_ADM == 0, "No",
                                                      ifelse(OTC_AT_ADM == 1, "Yes",
                                                             OTC_AT_ADM)))


# OTHERFLG Other Drug Reported at Admission
colnames(TEDS08)[58] <- "OTHER_AT_ADM"
TEDS08$OTHER_AT_ADM <- with(TEDS08, ifelse(OTHER_AT_ADM == 0, "No",
                                                      ifelse(OTHER_AT_ADM == 1, "Yes",
                                                             OTHER_AT_ADM)))


# ALCDRUG Substance Abuse Type -- ALcohol only, Other Drugs Obly, Alcohol and Other Drugs, or None
colnames(TEDS08)[59] <- "SUB_ABUSE_TYPE"
TEDS08$SUB_ABUSE_TYPE <- with(TEDS08, ifelse(SUB_ABUSE_TYPE == 0, "None",
                                                        ifelse(SUB_ABUSE_TYPE == 1, "Alcohol Only",
                                                        ifelse(SUB_ABUSE_TYPE == 2, "Other Drugs Only",
                                                        ifelse(SUB_ABUSE_TYPE == 3, "Alcohol & Other Drugs",
                                                               SUB_ABUSE_TYPE)))))


# DSMCRIT DSM Diagnosis
colnames(TEDS08)[60] <- "DSM_DIAG"
TEDS08$DSM_DIAG <- with(TEDS08, ifelse(DSM_DIAG == 0, "No Diagnosis",
                                                  ifelse(DSM_DIAG == 1, "Alcohol-Induced Disorder",
                                                  ifelse(DSM_DIAG == 2, "Substance-Induced Disorder",
                                                  ifelse(DSM_DIAG == 3, "Alcohol Intoxication",
                                                  ifelse(DSM_DIAG == 4, "Alcohol Dependence",
                                                  ifelse(DSM_DIAG == 5, "Opioid Dependence",
                                                  ifelse(DSM_DIAG == 6, "Cocaine Dependence",
                                                  ifelse(DSM_DIAG == 7, "Cannabis Dependence",
                                                  ifelse(DSM_DIAG == 8, "Other Substance Dependence",
                                                  ifelse(DSM_DIAG == 9, "Alcohol Abuse",
                                                  ifelse(DSM_DIAG == 10, "Cannabis Abuse",
                                                  ifelse(DSM_DIAG == 11, "Other Substance Abuse",
                                                  ifelse(DSM_DIAG == 12, "Opioid Abuse",
                                                  ifelse(DSM_DIAG == 13, "Cocaine Abuse",
                                                  ifelse(DSM_DIAG == 14, "Anxiety Disorders",
                                                  ifelse(DSM_DIAG == 15, "Depressive Disorders",
                                                  ifelse(DSM_DIAG == 16, "Schizophrenia/Other Psychotic Disorders",
                                                  ifelse(DSM_DIAG == 17, "Bipolar Disorders",
                                                  ifelse(DSM_DIAG == 18, "Attention Deficit/Disruptive Behavior Disorders",
                                                  ifelse(DSM_DIAG == 19, "Other Mental Health Condition",
                                                  ifelse(DSM_DIAG == 20, "Other Condition",
                                                  ifelse(DSM_DIAG == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         DSM_DIAG)))))))))))))))))))))))


# PSYPROB Psychiatric Problems in Addition to Alcohol/Drug Problem 61
TEDS08$PSYPROB <- with(TEDS08, ifelse(PSYPROB == 1, "Yes",
                                                  ifelse(PSYPROB == 2, "No",
                                                  ifelse(PSYPROB == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PSYPROB))))


# HLTHINS Health Insurance 62
TEDS08$HLTHINS <- with(TEDS08, ifelse(HLTHINS == 1, "Private Insurance, BC/BS, HMO",
                                                  ifelse(HLTHINS == 2, "Medicaid",
                                                  ifelse(HLTHINS == 3, "Medicare, Other",
                                                  ifelse(HLTHINS == 4, "None",
                                                  ifelse(HLTHINS == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         HLTHINS))))))


# PRIMPAY Expected/Acutal Source of Payment 63
TEDS08$PRIMPAY <- with(TEDS08, ifelse(PRIMPAY == 1, "Self-Pay",
                                                  ifelse(PRIMPAY == 2, "BC/BS, Other Health Insurance Company",
                                                  ifelse(PRIMPAY == 3, "Medicare, Workers Comp",
                                                  ifelse(PRIMPAY == 4, "Medicaid",
                                                  ifelse(PRIMPAY == 5, "Other Govt Program",
                                                  ifelse(PRIMPAY == 8, "No Charge (Free, Charity, Special Research, Teaching)",
                                                  ifelse(PRIMPAY == 9, "Other",
                                                  ifelse(PRIMPAY == -9, "MISSING/UNKNOWN/NOT COLLECTED/INVALID",
                                                         PRIMPAY)))))))))

```

##### Data Exploration

*Data Combined for Exploration*

```{r}

dim(TEDS01)
dim(TEDS02)
dim(TEDS03)
dim(TEDS04)
dim(TEDS05)
dim(TEDS06)
dim(TEDS07)
dim(TEDS08)

dim(TEDS01)[1] + dim(TEDS02)[1] + dim(TEDS03)[1] + dim(TEDS04)[1] + dim(TEDS05)[1] + dim(TEDS06)[1] + dim(TEDS07)[1] + dim(TEDS08)[1]

# Combining all of the datasets into 1

dat_all <- rbind(TEDS01, TEDS02, TEDS03, TEDS04, TEDS05, TEDS06, TEDS07, TEDS08)

# Verifying that we have the correct dimension.
dim(TEDS_ADM)

```



_At this point the data was moved into the GoFirst Cluster, HDFS by Matt._


##### Spark Configuration and Data Read-In
```{r}

config <- spark_config()
config$`sparklyr.shell.driver-memory`<- "8G"
config$`sparklyr.shell.executor-memory`<- "4G"
config$spark.yarn.executor.memoryOverhead<- "1g"

sc <- spark_connect(master = "yarn-client", version="2.2.0", spark_home = '/opt/cloudera/parcels/SPARK2-2.2.0.cloudera1-1.cdh5.12.0.p0.142354/lib/spark2',config = config)

path.data <- "hdfs:///user/bprice5/opiate/teds01.csv"
path.data2 <- "hdfs:///user/bprice5/opiate/teds02.csv"
path.data3 <- "hdfs:///user/bprice5/opiate/teds03.csv"
path.data4 <- "hdfs:///user/bprice5/opiate/teds04.csv"
path.data5 <- "hdfs:///user/bprice5/opiate/teds05.csv"
path.data6 <- "hdfs:///user/bprice5/opiate/teds06.csv"
path.data7 <- "hdfs:///user/bprice5/opiate/teds07.csv"
path.data8 <- "hdfs:///user/bprice5/opiate/teds08.csv"

teds <- spark_read_csv(sc, "teds", path = path.data)
teds2 <- spark_read_csv(sc, "teds2", path = path.data2)
teds3 <- spark_read_csv(sc, "teds3", path = path.data3)
teds4 <- spark_read_csv(sc, "teds4", path = path.data4)
teds5 <- spark_read_csv(sc, "teds5", path = path.data5)
teds6 <- spark_read_csv(sc, "teds6", path = path.data6)
teds7 <- spark_read_csv(sc, "teds7", path = path.data7)
teds8 <- spark_read_csv(sc, "teds8", path = path.data8)

# Combine all into one table.
teds_total <- sdf_bind_rows(teds,teds2,teds3,teds4,teds5,teds6,teds7,teds8, id = NULL)

```


##### Prepare for Modeling

```{r}

#Subset
demos <- teds_total %>% 
  select(60, 3:18, 20:21, 25, 62:64, PRIME_SUB, SEC_SUB, TERT_SUB)

# Partition the dataset 75/25
partitions <- sdf_partition(demos, training = 0.75, test = 0.25, seed = 1978)

```

##### Random Forest Models
```{r}

# Model with 75/25 split
# Try a model
rf_teds1 <- partitions$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds1_preds <- sdf_predict(rf_teds1, partitions$test)

rf_eval <- ml_multiclass_classification_evaluator(rf_teds1_preds, metric_name = "accuracy")
rf_eval_prec <- ml_multiclass_classification_evaluator(rf_teds1_preds, metric_name = "weightedPrecision")

rf_eval
rf_eval_prec
# 0.4586 Accuracy
# 0.5238726 Precision

preds_sub <- rf_teds1_preds %>% 
  select(SUB_ABUSE_TYPE, label, rawPrediction, probability, predicted_label, probability_Alcohol__Other_Drugs, probability_Alcohol_Only, probability_Other_Drugs_Only, probability_None)

```


```{r}

# Subset further. Less Years, I want to see if having fewer years will give us better accuracy.

dat95_15 <- demos %>%   
  filter(YEAR >= 1995) %>% 
  sdf_partition(training = 0.75, test = 0.25, seed = 1978)

dat00_15 <- demos %>% 
  filter(YEAR >= 2000) %>% 
  sdf_partition(training = 0.75, test = 0.25, seed = 1978)

dat01_15 <- demos %>% 
  filter(YEAR >= 2001) %>% 
  sdf_partition(training = 0.75, test = 0.25, seed = 1978)

dat02_15 <- demos %>% 
  filter(YEAR >= 2002) %>% 
  sdf_partition(training = 0.75, test = 0.25, seed = 1978)

dat03_15 <- demos %>% 
  filter(YEAR >= 2003) %>% 
  sdf_partition(training = 0.75, test = 0.25, seed = 1978)
  

dat05_15 <- demos %>% 
  filter(YEAR >= 2005) %>% 
  sdf_partition(training = 0.75, test = 0.25, seed = 1978)

  
  #### Best RF Model subset
dat10_15 <- demos %>% 
  filter(YEAR >= 2010) %>% 
  sdf_partition(training = 0.75, test = 0.25, seed = 1978)

```


##### Random Forest Model with Different Year Ranges
```{r}

# 1995-2015
rf_teds_95_15 <- dat95_15$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds_95_15_preds <- sdf_predict(dat95_15$test, rf_teds_95_15)

rf_eval_95_15 <- ml_multiclass_classification_evaluator(rf_teds_95_15_preds, metric_name = "accuracy")
rf_eval_prec_95_15 <- ml_multiclass_classification_evaluator(rf_teds_95_15_preds, metric_name = "weightedPrecision")


# 2000-2015
rf_teds_00_15 <- dat00_15$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds_00_15_preds <- sdf_predict(dat00_15$test, rf_teds_00_15)

rf_eval_00_15 <- ml_multiclass_classification_evaluator(rf_teds_00_15_preds, metric_name = "accuracy")
rf_eval_prec_00_15 <- ml_multiclass_classification_evaluator(rf_teds_00_15_preds, metric_name = "weightedPrecision")



# 2001-2015
rf_teds_01_15 <- dat01_15$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds_01_15_preds <- sdf_predict(dat01_15$test, rf_teds_01_15)

rf_eval_01_15 <- ml_multiclass_classification_evaluator(rf_teds_01_15_preds, metric_name = "accuracy")
rf_eval_prec_01_15 <- ml_multiclass_classification_evaluator(rf_teds_01_15_preds, metric_name = "weightedPrecision")
head(rf_teds_01_15_preds)


# 2002-2015
rf_teds_02_15 <- dat02_15$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds_02_15_preds <- sdf_predict(dat02_15$test, rf_teds_02_15)

rf_eval_02_15 <- ml_multiclass_classification_evaluator(rf_teds_02_15_preds, metric_name = "accuracy")
rf_eval_prec_02_15 <- ml_multiclass_classification_evaluator(rf_teds_02_15_preds, metric_name = "weightedPrecision")


# 2003-2015
rf_teds_03_15 <- dat03_15$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds_03_15_preds <- sdf_predict(dat03_15$test, rf_teds_03_15)

rf_eval_03_15 <- ml_multiclass_classification_evaluator(rf_teds_03_15_preds, metric_name = "accuracy")
rf_eval_prec_03_15 <- ml_multiclass_classification_evaluator(rf_teds_03_15_preds, metric_name = "weightedPrecision")


# 2005-2015
rf_teds_05_15 <- dat05_15$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds_05_15_preds <- sdf_predict(dat05_15$test, rf_teds_05_15)

rf_eval_05_15 <- ml_multiclass_classification_evaluator(rf_teds_05_15_preds, metric_name = "accuracy")
rf_eval_prec_05_15 <- ml_multiclass_classification_evaluator(rf_teds_05_15_preds, metric_name = "weightedPrecision")

 #### Best RF Model
# 2010-2015
rf_teds_10_15 <- dat10_15$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

rf_teds_10_15_preds <- sdf_predict(dat10_15$test, rf_teds_10_15)

rf_eval_10_15 <- ml_multiclass_classification_evaluator(rf_teds_10_15_preds, metric_name = "accuracy")
rf_eval_prec_10_15 <- ml_multiclass_classification_evaluator(rf_teds_10_15_preds, metric_name = "weightedPrecision")

```


Evaluations
```{r}

rf_eval_95_15       # 0.4614166 Accuracy
rf_eval_prec_95_15  # 0.5106527 Precision

rf_eval_00_15       # 0.4731435 Accuracy
rf_eval_prec_00_15  # 0.4989894 Precision

rf_eval_01_15       # 0.4742899 Accuracy
rf_eval_prec_01_15  # 0.4957312 Precision

rf_eval_02_15       # 0.4722933 Accuracy
rf_eval_prec_02_15  # 0.4937764 Precision

rf_eval_03_15       # 0.4658824 Accuracy
rf_eval_prec_03_15  # 0.4857461 Prediction

rf_eval_05_15       # 0.4657564 Accuracy
rf_eval_prec_05_15  # 0.4859559 Precision

rf_eval_10_15       # 0.4655189 Accuracy
rf_eval_prec_10_15  # 0.4888082 Precision

```


##### Decision Tree Models

```{r}
# Decision Tree On 75/25 Split
dec_tree_teds1 <- ml_decision_tree(partitions$training, SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type = "classification")


dec_tree_preds <- sdf_predict(dec_tree_teds1, partitions$test)

dec_tree1 <- ml_multiclass_classification_evaluator(dec_tree_preds, method = "accuracy") 

dec_tree1

# 0.4643188 Accuracy

```

##### Decision Tree With shorter year windows
```{r}

# 2000-2015
dec_teds_00_15 <- dat00_15$training %>% 
  ml_decision_tree(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

dec_teds_00_15_preds <- sdf_predict(dat00_15$test, dec_teds_00_15)

dec_eval_00_15 <- ml_multiclass_classification_evaluator(dec_teds_00_15_preds, metric_name = "accuracy")
dec_eval_prec_00_15 <- ml_multiclass_classification_evaluator(dec_teds_00_15_preds, metric_name = "weightedPrecision")


# 2001-2015
dec_teds_01_15 <- dat01_15$training %>% 
  ml_decision_tree(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

dec_teds_01_15_preds <- sdf_predict(dat01_15$test, dec_teds_01_15)

dec_eval_01_15 <- ml_multiclass_classification_evaluator(dec_teds_01_15_preds, metric_name = "accuracy")
dec_eval_prec_01_15 <- ml_multiclass_classification_evaluator(dec_teds_01_15_preds, metric_name = "weightedPrecision")


# 2002-2015
dec_teds_02_15 <- dat02_15$training %>% 
  ml_decision_tree(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

dec_teds_02_15_preds <- sdf_predict(dat02_15$test, dec_teds_02_15)

dec_eval_02_15 <- ml_multiclass_classification_evaluator(dec_teds_02_15_preds, metric_name = "accuracy")
dec_eval_prec_02_15 <- ml_multiclass_classification_evaluator(dec_teds_02_15_preds, metric_name = "weightedPrecision")


# 2003-2015
dec_teds_03_15 <- dat03_15$training %>% 
  ml_decision_tree(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

dec_teds_03_15_preds <- sdf_predict(dat03_15$test, dec_teds_03_15)

dec_eval_03_15 <- ml_multiclass_classification_evaluator(dec_teds_03_15_preds, metric_name = "accuracy")
dec_eval_prec_03_15 <- ml_multiclass_classification_evaluator(dec_teds_03_15_preds, metric_name = "weightedPrecision")


# 2005-2015
dec_teds_05_15 <- dat05_15$training %>% 
  ml_decision_tree(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

dec_teds_05_15_preds <- sdf_predict(dat05_15$test, dec_teds_05_15)

dec_eval_05_15 <- ml_multiclass_classification_evaluator(dec_teds_05_15_preds, metric_name = "accuracy")
dec_eval_prec_05_15 <- ml_multiclass_classification_evaluator(dec_teds_05_15_preds, metric_name = "weightedPrecision")


# 2010-2015
set.seed(1978)
dec_teds_10_15 <- dat10_15$training %>% 
  ml_decision_tree(SUB_ABUSE_TYPE ~ . - YEAR - PRIME_SUB - SEC_SUB - TERT_SUB, type  = "classification")

dec_teds_10_15_preds <- sdf_predict(dat10_15$test, dec_teds_10_15)

dec_eval_10_15 <- ml_multiclass_classification_evaluator(dec_teds_10_15_preds, metric_name = "accuracy")
dec_eval_prec_10_15 <- ml_multiclass_classification_evaluator(dec_teds_10_15_preds, metric_name = "weightedPrecision")

```

```{r}

dec_eval_00_15       # 0.4613538 Accuracy
dec_eval_prec_00_15  # 0.4622409 Precision

dec_eval_01_15       # 0.4703235 Accuracy
dec_eval_prec_01_15  # 0.4628716 Precision

dec_eval_02_15       # 0.4715651 Accuracy
dec_eval_prec_02_15  # 0.4635006 Precision

dec_eval_03_15       # 0.4721687 Accuracy
dec_eval_prec_03_15  # 0.4612932 Prediction

dec_eval_05_15       # 0.4569278 Accuracy
dec_eval_prec_05_15  # 0.4402879 Precision

dec_eval_10_15       # 0.4881663 Accuracy
dec_eval_prec_10_15  # 0.4621931 Precision

```

##### Creating new response variable formulas
```{r}

form1 <- SUB_ABUSE_TYPE ~ AGE + GENDER + RACE + MARITAL_STATUS + EDUC + EMPLOYMENT_STATUS + VETERAN + LIVING_ARR + PRIMARY_INC + STATE + CBSA + REGION + CENSUS_DIV + PSOURCE + PSYPROB + HLTHINS + PRIMPAY

form2 <- SUB_ABUSE_TYPE ~ AGE + GENDER +  EMPLOYMENT_STATUS + EDUC

form3 <- SUB_ABUSE_TYPE ~ AGE + GENDER +  EMPLOYMENT_STATUS + EDUC + MARITAL_STATUS 

form4 <- SUB_ABUSE_TYPE ~ AGE + GENDER +  EMPLOYMENT_STATUS + EDUC + VETERAN + LIVING_ARR + PRIMARY_INC + STATE +  PSOURCE + PSYPROB + HLTHINS + PRIMPAY

form5 <- SUB_ABUSE_TYPE ~ AGE + GENDER +  EMPLOYMENT_STATUS + EDUC + MARITAL_STATUS + LIVING_ARR + PRIMARY_INC + CENSUS_DIV + PSOURCE

form6 <- SUB_ABUSE_TYPE ~ AGE + GENDER +  EMPLOYMENT_STATUS + EDUC + MARITAL_STATUS + LIVING_ARR + PRIMARY_INC + ARRESTS + REGION + PSOURCE

form7 <- SUB_ABUSE_TYPE ~ AGE + GENDER +  EMPLOYMENT_STATUS + EDUC + MARITAL_STATUS + LIVING_ARR + CBSA +  PSOURCE

form8 <- SUB_ABUSE_TYPE ~ AGE + GENDER +  EMPLOYMENT_STATUS + EDUC + MARITAL_STATUS + LIVING_ARR + PRIMARY_INC + REGION + PSOURCE + VETERAN + PSYPROB + HLTHINS + PRIMPAY

```


##### Decision Tree models with new response variable formulas.
```{r}

# 1995-2015
dec1 <- dat95_15$training %>% 
  ml_decision_tree(formula = form1, type  = "classification")

dec1_preds <- sdf_predict(dat95_15$test, dec1)


dec1_eval <- ml_multiclass_classification_evaluator(dec1_preds, metric_name = "accuracy")
dec1_prec <- ml_multiclass_classification_evaluator(dec1_preds, metric_name = "weightedPrecision")

####

dec2 <- dat95_15$training %>% 
  ml_decision_tree(formula = form2, type  = "classification")

dec2_preds <- sdf_predict(dat95_15$test, dec2)

dec2_eval <- ml_multiclass_classification_evaluator(dec2_preds, metric_name = "accuracy")
dec2_prec <- ml_multiclass_classification_evaluator(dec2_preds, metric_name = "weightedPrecision")

####

dec3 <- dat95_15$training %>% 
  ml_decision_tree(formula = form3, type  = "classification")

dec3_preds <- sdf_predict(dat95_15$test, dec3)

dec3_eval <- ml_multiclass_classification_evaluator(dec3_preds, metric_name = "accuracy")
dec3_prec <- ml_multiclass_classification_evaluator(dec3_preds, metric_name = "weightedPrecision")

####

dec4 <- dat95_15$training %>% 
  ml_decision_tree(formula = form4, type  = "classification")

dec4_preds <- sdf_predict(dat95_15$test, dec4)

dec4_eval <- ml_multiclass_classification_evaluator(dec4_preds, metric_name = "accuracy")
dec4_prec <- ml_multiclass_classification_evaluator(dec4_preds, metric_name = "weightedPrecision")

####

dec5 <- dat95_15$training %>% 
  ml_decision_tree(formula = form5, type  = "classification")

dec5_preds <- sdf_predict(dat95_15$test, dec5)

dec5_eval <- ml_multiclass_classification_evaluator(dec5_preds, metric_name = "accuracy")
dec5_prec <- ml_multiclass_classification_evaluator(dec5_preds, metric_name = "weightedPrecision")

####

dec6 <- dat95_15$training %>% 
  ml_decision_tree(formula = form6, type  = "classification")

dec6_preds <- sdf_predict(dat95_15$test, dec6)

dec6_eval <- ml_multiclass_classification_evaluator(dec6_preds, metric_name = "accuracy")
dec6_prec <- ml_multiclass_classification_evaluator(dec6_preds, metric_name = "weightedPrecision")
  

####

dec7 <- dat95_15$training %>% 
  ml_decision_tree(formula = form7, type  = "classification")

dec7_preds <- sdf_predict(dat95_15$test, dec7)

dec7_eval <- ml_multiclass_classification_evaluator(dec7_preds, metric_name = "accuracy")
dec7_prec <- ml_multiclass_classification_evaluator(dec7_preds, metric_name = "weightedPrecision")

####

dec8 <- dat95_15$training %>% 
  ml_decision_tree(formula = form8, type  = "classification")

dec8_preds <- sdf_predict(dat95_15$test, dec8)

dec8_eval <- ml_multiclass_classification_evaluator(dec8_preds, metric_name = "accuracy")
dec8_prec <- ml_multiclass_classification_evaluator(dec8_preds, metric_name = "weightedPrecision")

```

```{r}

#dec1_eval # Errors Out
#dec1_prec # Errors Out

dec2_eval # 0.4182953
dec2_prec # 0.4172941

dec3_eval # 0.4203851
dec3_prec # 0.4115709

dec4_eval # 0.4424463
dec4_prec # 0.4795384

dec5_eval # 0.4246532
dec5_prec # 0.4272093

dec6_eval # 0.4534405
dec6_prec # 0.4534518

#dec7_eval # Erros Out
#dec7_prec # Erros Out

dec8_eval # 0.4542378
dec8_prec # 0.45617

```

Since dec8 from 95-2015 worked best, tried it on the time frame thatr worked best for random forest.
```{r}

dec8_10_15 <- dat10_15$training %>% 
  ml_decision_tree(formula = form8, type  = "classification", seed = 1978)

dec8_10_15preds <- sdf_predict(dat10_15$test, dec8_10_15)

dec8_10_15eval <- ml_multiclass_classification_evaluator(dec8_10_15preds, metric_name = "accuracy")
dec8_10_15prec <- ml_multiclass_classification_evaluator(dec8_10_15preds, metric_name = "weightedPrecision")

dec8_10_15eval # 0.480427
dec8_10_15prec # 0.4513386

head(dec8_10_15preds)


dec8_10_15_feat_imp <- ml_tree_feature_importance(dec8_10_15)
dec8_10_15_feat_imp

```


##### Collecting the best results, from the 2010-2015 decision tree models with all of the variables.
```{r}

dec_collection1 <- dec_teds_10_15_preds %>% 
  select(1:5) %>% 
  collect()
dec_collection2 <- dec_teds_10_15_preds %>% 
  select(6:10) %>%
  collect()
dec_collection3 <- dec_teds_10_15_preds %>% 
  select(11:15) %>%
  collect()
dec_collection4 <- dec_teds_10_15_preds %>% 
  select(16:18) %>%
  collect()
dec_collection5 <- dec_teds_10_15_preds %>% 
  select(18:21) %>%
  collect()
dec_collection6 <- dec_teds_10_15_preds %>% 
  select(22:23) %>%
  collect()

dec_collection8 <- dec_teds_10_15_preds %>% 
  select(25:26) %>%
  collect()
dec_collection9 <- dec_teds_10_15_preds %>% 
  select(27:28) %>%
  collect()
dec_collection10 <- dec_teds_10_15_preds %>% 
  select(29:30) %>%
  collect()
dec_collection11 <- dec_teds_10_15_preds %>% 
  select(31:32) %>%
  collect()
dec_collection12 <- dec_teds_10_15_preds %>% 
  select(33) %>%
  collect()

dec_collection7 <- dec_teds_10_15_preds %>%    # features column ran for 45 minutes with no error
  select(24) %>%                             # but also didn't finish
  collect()


dec_coll <- cbind(dec_collection1, dec_collection2, dec_collection3, dec_collection4, dec_collection5, dec_collection6, dec_collection8, dec_collection9, dec_collection10, dec_collection11, dec_collection12)

```

##### Evaluating the best model
```{r}

preds1 <- dec_coll

char_vars <- lapply(preds1, class) == "character"

preds1[, char_vars] <- lapply(preds1[, char_vars], as.factor)

confusionMatrix(actuals = preds1$label, predictedScores =  preds1$prediction)
#                                 0       1       2       3   
#                                 <int>   <int>   <int>   <int>
# 0	(Other Drugs Only)            835919	508375	192541	23521		
# 1	(Alcohol & Other Drugs)       305714	373902	355991	12890
# Names Added by me.

caret::confusionMatrix(preds1$predicted_label, preds1$SUB_ABUSE_TYPE)
#                       Reference
# Prediction              Alcohol & Other Drugs Alcohol Only   None Other Drugs Only
#   Alcohol & Other Drugs                238118       156474   6832           197780
#   Alcohol Only                         135784       199517   6058           107934
#   None                                      0            0      0                0
#   Other Drugs Only                     508375       192541  23521           835919

precision(actuals =  preds1$label, predictedScores =  preds1$prediction)
# Positive Predicted Value - 0.3566076

sensitivity(actuals = preds1$label, predictedScores = preds1$prediction)
# True Posistive Rate - 0.4237921

specificity(actuals = preds1$label, predictedScores = preds1$prediction)
# False Positive Rate - 0.6092874

npv(actuals = preds1$label, predictedScores = preds1$prediction)
# Negative Predictive Value - 0.6741929

youdensIndex(actuals = preds1$label, predictedScores = preds1$prediction)
# proportions of correctly predicted observations for both events - 0.03307947

misClassError(actuals = preds1$label, predictedScores = preds1$prediction)
# Proportion of all events incorrectly classified - 0.5363

```

#### Modeling on the Opiates only Dataset


##### Subest for Opiods only ar Admission (could be primary, secondary, or tertiary substance.

```{r}

teds_op <- teds_total %>% 
  filter(OPIATE_AT_ADM == "Yes")

```

_The formulas used for modeling will be the same as the formulas used in the multclass above._

##### Partition the Data 75/25 Test/Train

```{r}

part1 <- sdf_partition(teds_op, training = 0.75, test = 0.25, seed = 1978)

```


```{r}
set.seed(1978)
rf1 <- part1$training %>% 
  ml_random_forest(formula = form1, type = "classification")

rf1_preds <- sdf_predict(part1$test, rf1)
rf1_preds

rf1_roc <- ml_binary_classification_eval(rf1_preds, metric_name = "areaUnderROC")

rf1_acc <- ml_multiclass_classification_evaluator(rf1_preds, metric_name = "accuracy")

rf1_feat_imp <- ml_tree_feature_importance(rf1)

rf1_predlab <- rf1_preds %>% 
  select(predicted_label) %>% 
  collect()

test_lab <- part1$test %>% 
  select(SUB_ABUSE_TYPE) %>% 
  collect()

####

set.seed(1978)
rf2 <- part1$training %>% 
  ml_random_forest(formula = form2, type = "classification")

rf2_preds <- sdf_predict(part1$test, rf2)
rf2_preds

rf2_roc <- ml_binary_classification_eval(rf2_preds, metric_name = "areaUnderROC")

rf2_acc <- ml_multiclass_classification_evaluator(rf2_preds, metric_name = "accuracy")

rf2_feat_imp <- ml_tree_feature_importance(rf2)

####

set.seed(1978)
rf3 <- part1$training %>% 
  ml_random_forest(formula = form3, type = "classification")

rf3_preds <- sdf_predict(part1$test, rf3)
rf3_preds

rf3_roc <- ml_binary_classification_eval(rf3_preds, metric_name = "areaUnderROC")

rf3_acc <- ml_multiclass_classification_evaluator(rf3_preds, metric_name = "accuracy")

rf3_feat_imp <- ml_tree_feature_importance(rf3)

####

set.seed(1978)
rf4 <- part1$training %>% 
  ml_random_forest(formula = form4, type = "classification")

rf4_preds <- sdf_predict(part1$test, rf4)
rf4_preds

rf4_roc <- ml_binary_classification_eval(rf4_preds, metric_name = "areaUnderROC")

rf4_acc <- ml_multiclass_classification_evaluator(rf4_preds, metric_name = "accuracy")

rf4_feat_imp <- ml_tree_feature_importance(rf4)

####

set.seed(1978)
rf5 <- part1$training %>% 
  ml_random_forest(formula = form5, type = "classification")

rf5_preds <- sdf_predict(part1$test, rf5)
rf5_preds

rf5_roc <- ml_binary_classification_eval(rf5_preds, metric_name = "areaUnderROC")

rf5_acc <- ml_multiclass_classification_evaluator(rf5_preds, metric_name = "accuracy")

rf5_feat_imp <- ml_tree_feature_importance(rf5)

####

set.seed(1978)
rf6 <- part1$training %>% 
  ml_random_forest(formula = form6, type = "classification")

rf6_preds <- sdf_predict(part1$test, rf6)
rf6_preds

rf6_roc <- ml_binary_classification_eval(rf6_preds, metric_name = "areaUnderROC")

rf6_acc <- ml_multiclass_classification_evaluator(rf6_preds, metric_name = "accuracy")

rf6_feat_imp <- ml_tree_feature_importance(rf6)

####

set.seed(1978)
rf7 <- part1$training %>% 
  ml_random_forest(formula = form7, type = "classification")

rf7_preds <- sdf_predict(part1$test, rf7)
rf7_preds

rf7_roc <- ml_binary_classification_eval(rf7_preds, metric_name = "areaUnderROC")

rf7_acc <- ml_multiclass_classification_evaluator(rf7_preds, metric_name = "accuracy")

rf7_feat_imp <- ml_tree_feature_importance(rf7)

####

set.seed(1978)
rf8 <- part1$training %>% 
  ml_random_forest(SUB_ABUSE_TYPE ~ PSOURCE, type = "classification")

rf8_preds <- sdf_predict(part1$test, rf8)
rf8_roc <- ml_binary_classification_eval(rf8_preds, metric_name = "areaUnderROC")



```

```{r}

rf1_roc # 0.6372517
rf1_acc # 0.6875894

rf2_roc # 0.5893068
rf2_acc # 0.6875894

rf3_roc # 0.5911959
rf3_acc # 0.6875894

rf4_roc # 0.6284515
rf4_acc # 0.6875894

rf5_roc # 0.6201023
rf5_acc # 0.6875894

rf6_roc # 0.6248128
rf6_acc # 0.6875894

rf7_roc # 0.6194637
rf7_acc # 0.6875894

rf8_roc # 0.5600763
rf8_roc # 0.6875894

```

```{r}

gb1 <- part1$training %>% 
  ml_gradient_boosted_trees(formula = form1, type = "classification", thresholds = c(0.6, 0.4), seed = 1978)

gb1_preds <- sdf_predict(part1$test, gb1)

gb1_labs <- gb1_preds %>% 
  select(predicted_label) %>% 
  collect()

gb1_roc <- ml_binary_classification_eval(gb1_preds, metric_name = "areaUnderROC")

gb1_acc <- ml_multiclass_classification_evaluator(gb1_preds, metric_name = "accuracy")

gb1_roc # 0.6519557
gb1_acc # 0.6803817

####

gb2 <- part1$training %>% 
  ml_gradient_boosted_trees(formula = form2, type = "classification", thresholds = c(0.5, 0.5), seed = 1978)

gb2_preds <- sdf_predict(part1$test, gb2)
gb2_preds

gb2_roc <- ml_binary_classification_eval(gb2_preds, metric_name = "areaUnderROC")

gb2_acc <- ml_multiclass_classification_evaluator(gb2_preds, metric_name = "accuracy")

####

set.seed(1978)
gb3 <- part1$training %>% 
  ml_gradient_boosted_trees(formula = form3, type = "classification", thresholds = c(0.5, 0.5), seed = 1978)

gb3_preds <- sdf_predict(part1$test, gb3)
gb3_preds

gb3_roc <- ml_binary_classification_eval(gb3_preds, metric_name = "areaUnderROC")

gb3_acc <- ml_multiclass_classification_evaluator(gb3_preds, metric_name = "accuracy")

####

set.seed(1978)
gb4 <- part1$training %>% 
  ml_gradient_boosted_trees(formula = form4, type = "classification", thresholds = c(0.5, 0.5), seed = 1978)

gb4_preds <- sdf_predict(part1$test, gb4)
gb4_preds

gb4_roc <- ml_binary_classification_eval(gb4_preds, metric_name = "areaUnderROC")

gb4_acc <- ml_multiclass_classification_evaluator(gb4_preds, metric_name = "accuracy")

####

set.seed(1978)
gb5 <- part1$training %>% 
  ml_gradient_boosted_trees(formula = form5, type = "classification", thresholds = c(0.5, 0.5), seed = 1978)

gb5_preds <- sdf_predict(part1$test, gb5)
gb5_preds

gb5_roc <- ml_binary_classification_eval(gb5_preds, metric_name = "areaUnderROC")

gb5_acc <- ml_multiclass_classification_evaluator(gb5_preds, metric_name = "accuracy")

####

gb6 <- part1$training %>% 
  ml_gradient_boosted_trees(formula = form6, type = "classification", thresholds = c(0.5, 0.5), seed = 1978)

gb6_preds <- sdf_predict(part1$test, gb6)

gb6_roc <- ml_binary_classification_eval(gb6_preds, metric_name = "areaUnderROC")

gb6_acc <- ml_multiclass_classification_evaluator(gb6_preds, metric_name = "accuracy")

gb6_feat_imp <- ml_tree_feature_importance(gb6)

```

```{r}

gb1_roc # 0.6519557
gb1_acc # 0.6803817

gb2_roc # 0.5964395
gb2_acc # 0.6872665

gb3_roc # 0.5998008
gb3_acc # 0.6873183

gb4_roc # 0.6483277
gb4_acc # 0.6927333

gb5_roc # 0.64054
gb5_acc # 0.6916433

gb6_roc # 0.6435274
gb6_acc # 0.691966

```


#####  Collect Best Model
```{r}

gb6_collection1 <- gb6_preds %>% 
  select(SUB_ABUSE_TYPE, label, rawPrediction) %>% 
  collect()
gb6_collection2 <- gb6_preds %>% 
  select(probability, prediction) %>% 
  collect()
gb6_collection3 <- gb6_preds %>% 
  select(predicted_label, probability_Other_Drugs_Only, probability_Alcohol__Other_Drugs) %>% 
  collect()
gb6_collection4 <- gb6_preds %>% 
  select(2:5) %>% 
  collect()
gb6_collection5 <- gb6_preds %>% 
  select(6:10) %>% 
  collect()
gb6_collection6 <- gb6_preds %>% 
  select(11:15) %>% 
  collect()
gb6_collection7 <- gb6_preds %>% 
  select(16:20) %>% 
  collect()
gb6_collection8 <- gb6_preds %>% 
  select(21:25) %>% 
  collect()
gb6_collection9 <- gb6_preds %>% 
  select(26:30) %>% 
  collect()
gb6_collection10 <- gb6_preds %>% 
  select(31:35) %>% 
  collect()
gb6_collection11 <- gb6_preds %>% 
  select(36:40) %>% 
  collect()
gb6_collection12 <- gb6_preds %>% 
  select(41:45) %>% 
  collect()
gb6_collection13 <- gb6_preds %>% 
  select(46:50) %>% 
  collect()
gb6_collection14 <- gb6_preds %>% 
  select(51:55) %>% 
  collect()
gb6_collection15 <- gb6_preds %>% 
  select(56:59) %>% 
  collect()
gb6_collection16 <- gb6_preds %>% 
  select(61:64) %>% 
  collect()

gb6_collected <- cbind(gb6_collection1, gb6_collection2, gb6_collection3, gb6_collection4, gb6_collection5, gb6_collection6, gb6_collection7, gb6_collection8, gb6_collection9, gb6_collection10, gb6_collection11, gb6_collection12, gb6_collection13, gb6_collection14, gb6_collection15, gb6_collection16)

```

```{r}

preds <- gb6_collected

char_vars <- lapply(preds, class) == "character"

preds[, char_vars] <- lapply(preds[, char_vars], as.factor)

plotROC(actuals = preds$label, predictedScores =  preds$probability_Alcohol__Other_Drugs)

confusionMatrix(actuals = preds$label, predictedScores =  preds$prediction)
#                                 0 (Other Drugs Only)      1 (Alcohol & Other Drugs)
#                                 <int>                       <int>
# 0	(Other Drugs Only)            510671	                    218161		
# 1	(Alcohol & Other Drugs)       19506  	                    23223	
# Names Added by me.

caret::confusionMatrix(preds$predicted_label, preds$SUB_ABUSE_TYPE)
#                        Reference
# Prediction              Alcohol & Other Drugs Other Drugs Only
#   Alcohol & Other Drugs                 23223            19506
#   Other Drugs Only                     218161           510671

precision(actuals =  preds$label, predictedScores =  preds$prediction)
# Positive Predicted Value - 0.5434951

caret::recall(preds$predicted_label, preds$SUB_ABUSE_TYPE)
# True Positive Rate - 0.0962077

sensitivity(actuals = preds$label, predictedScores = preds$prediction)
# True Posistive Rate - 0.0962077

specificity(actuals = preds$label, predictedScores = preds$prediction)
# False Positive Rate - 0.9632085

npv(actuals = preds$label, predictedScores = preds$prediction)
# Negative Predictive Value - 0.7006704

youdensIndex(actuals = preds$label, predictedScores = preds$prediction)
# proportions of correctly predicted observations for both events - 0.05941622

misClassError(actuals = preds$label, predictedScores = preds$prediction)
# Proportion of all events incorrectly classified - 0.308

```


#### Models for Primary Substance Used
```{r}

partitions_ps <- teds_total %>%
  sdf_partition(training = 0.7, test = 0.3, seed = 1234)


teds_frame_forest_2 <- partitions_ps$training %>%
  ml_random_forest(formula = PRIME_SUB ~., type = c("classification"))

teds_frame_forest_2_preds<- sdf_predict(teds_frame_forest_2,partitions_ps$test)

teds_frame_forest_2_preds <- ml_multiclass_classification_evaluator(teds_frame_forest_2_preds, metric_name = "accuracy")

teds_frame_forest_2_preds

## 0.738 => 73.8% accuracy

```

```{r}
teds_frame_forest_3 <- partitions$training %>%
  ml_random_forest(formula = PRIME_SUB ~ PSYPROB + SUB_ABUSE_TYPE, type = c("classification"))
  
teds_frame_forest_3_preds <- sdf_predict(teds_frame_forest_3,partitions$test)

teds_frame_forest_3_preds <- ml_multiclass_classification_evaluator(teds_frame_forest_3_preds, metric_name = "accuracy") %>%
  print()

## 57.0% Accuracy (PRIME_SUB ~ SUB_ABUSE_TYPE + PSYPROB)

```

##### Log Likelihood Visualiztions

# Log-Likelihood Formula Used

$$
\sum_{i=1}^n\sum_{c=1}^Cy_{ic}\log(\theta_{ic})
$$


```{r Setup by Class, include=FALSE}
set.seed(1010)
x=read.csv("/group/bprice5/noblis_data_18/class_predictions.csv")

probs=apply(x,1,function(z)
    {
      t(z/sum(z))
    }
  )
probs=t(probs)

ys=sapply(1:length(x[,1]),function(m)
    {
      rmultinom(1,1,probs[m,])
    }
  )

ys=t(ys)
by_class<-c(sum(ys[,1]*log(probs[,1])),
            sum(ys[,2]*log(probs[,2])),
            sum(ys[,3]*log(probs[,3])),
            sum(ys[,4]*log(probs[,4]))
            )

prob_other_drugs_only<-ys[,1]*log(probs[,1])
prob_alcohol_other_drugs<-ys[,2]*log(probs[,3])
prob_alcohol_only<-ys[,3]*log(probs[,3])
prob_none<-ys[,4]*log(probs[,4])

prob_other_drugs_only_n=prob_other_drugs_only[which(prob_other_drugs_only<0)]
prob_alcohol_other_drugs_n=prob_alcohol_other_drugs[which(prob_alcohol_other_drugs<0)]
prob_alcohol_only_n=prob_alcohol_only[which(prob_alcohol_only<0)]
prob_none_n=prob_none[which(prob_none<0)]

```


```{r Log-Likelihood Plot}
multiclass <- boxplot(
  c(prob_other_drugs_only_n,prob_alcohol_other_drugs_n,prob_alcohol_only_n,prob_none_n)~as.factor(c(rep(1,length(prob_other_drugs_only_n)),rep(2,length(prob_alcohol_other_drugs_n)),rep(3,length(prob_alcohol_only_n)),rep(4,length(prob_none_n)))),
  main="Log-Likelihood of Co-Usage by Class",
  xlab="Class",
  ylab="Log-Likelihood",
  col="gold",
  border="navy",
  names=c("Othr Drgs Only","Alchl+Othrs","Alchl Only","None")
  
)

summary(multiclass$stats)

```

```{r Setup with Alcohol, include=FALSE}

set.seed(1010)
alc=read.csv("/group/bprice5/noblis_data_18/alcohol-presence.csv")
alc=alc[,1:2]

alc_probs=apply(alc,1,function(q)
    {
      t(q/sum(q))
    }
  )
alc_probs=t(alc_probs)

alc_ys=sapply(1:length(alc[,1]),function(w)
    {
      rmultinom(1,1,alc_probs[w,])
    }
  )

alc_ys=t(alc_ys)
alc_by_class<-c(sum(alc_ys[,1]*log(alc_probs[,1])),
            sum(alc_ys[,2]*log(alc_probs[,2]))
            )

prob_alcohol_no <-alc_ys[,1]*log(alc_probs[,1])
prob_alcohol_yes<-alc_ys[,2]*log(alc_probs[,2])

prob_alcohol_no_n=prob_alcohol_no[which(prob_alcohol_no<0)]
prob_alcohol_yes_n=prob_alcohol_yes[which(prob_alcohol_yes<0)]


```


```{r Log-Likelihood Alcohol Plot}

alcohol<-boxplot(
  c(prob_alcohol_no_n,prob_alcohol_yes_n)~as.factor(c(rep(1,length(prob_alcohol_no_n)),rep(2,length(prob_alcohol_yes_n)))),
  main="Log-Likelihood of Co-Usage With Alcohol",
  xlab="Alcohol Present",
  ylab="Log-Likelihood",
  col="gold",
  border="navy",
  names=c("No","Yes")
)

summary(alcohol$stats)

```

```{r}

#spark_disconnect(sc)

```







